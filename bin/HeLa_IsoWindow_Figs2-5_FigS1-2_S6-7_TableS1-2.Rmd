---
title: "Figures2-5"
author: "Chris Hsu"
date: "2025-06-01"
output: html_document
---


# Libraries
```{r}

# 1. Clear all variables
rm(list = ls())

# 2. Detach all non-base packages
detach_all_packages <- function() {
  basic.packages <- c("package:stats", "package:graphics", "package:grDevices", 
                      "package:utils", "package:datasets", "package:methods", 
                      "package:base")
  
  loaded.packages <- search()[grepl("^package:", search())]
  packages.to.detach <- setdiff(loaded.packages, basic.packages)
  
  for (pkg in packages.to.detach) {
    try(detach(pkg, character.only = TRUE, unload = TRUE), silent = TRUE)
  }
}

detach_all_packages()

# 4. Clear console (RStudio only)
if (Sys.getenv("RSTUDIO") == "1") cat("\014")


loadedNamespaces()


library(plyr)
library(dplyr)
library(mzR)
library(ggplot2)
library(scales)
library(data.table)
library(stringr)
library(purrr)
library(patchwork)
library(tidyr)
library(readr)
library(vioplot)
library(broom)
library(ggpubr)
library(rstatix)


my_colors <- c( "#7CA0D4","#DE757B", "#8BA56F","#A48AD3", 
              "#2B8AAE", "#624894","#80003F", "#BADE86",
               "#073F80", "#40007F", "#E995EB", "#0A522A")



GeomSplitViolin <- ggproto("GeomSplitViolin", GeomViolin,
  draw_group = function(self, data, ..., draw_quantiles = NULL) {
    # Original function by Jan Gleixner (@jan-glx)
    # Adjustments by Wouter van der Bijl (@Axeman)
    data <- transform(data, xminv = x - violinwidth * (x - xmin), xmaxv = x + violinwidth * (xmax - x))
    grp <- data[1, "group"]
    newdata <- plyr::arrange(transform(data, x = if (grp %% 2 == 1) xminv else xmaxv), if (grp %% 2 == 1) y else -y)
    newdata <- rbind(newdata[1, ], newdata, newdata[nrow(newdata), ], newdata[1, ])
    newdata[c(1, nrow(newdata) - 1, nrow(newdata)), "x"] <- round(newdata[1, "x"])
    if (length(draw_quantiles) > 0 & !scales::zero_range(range(data$y))) {
      stopifnot(all(draw_quantiles >= 0), all(draw_quantiles <= 1))
      quantiles <- create_quantile_segment_frame(data, draw_quantiles, split = TRUE, grp = grp)
      aesthetics <- data[rep(1, nrow(quantiles)), setdiff(names(data), c("x", "y")), drop = FALSE]
      aesthetics$alpha <- rep(1, nrow(quantiles))
      both <- cbind(quantiles, aesthetics)
      quantile_grob <- GeomPath$draw_panel(both, ...)
      ggplot2:::ggname("geom_split_violin", grid::grobTree(GeomPolygon$draw_panel(newdata, ...), quantile_grob))
    }
    else {
      ggplot2:::ggname("geom_split_violin", GeomPolygon$draw_panel(newdata, ...))
    }
  }
)

create_quantile_segment_frame <- function(data, draw_quantiles, split = FALSE, grp = NULL) {
  dens <- cumsum(data$density) / sum(data$density)
  ecdf <- stats::approxfun(dens, data$y)
  ys <- ecdf(draw_quantiles)
  violin.xminvs <- (stats::approxfun(data$y, data$xminv))(ys)
  violin.xmaxvs <- (stats::approxfun(data$y, data$xmaxv))(ys)
  violin.xs <- (stats::approxfun(data$y, data$x))(ys)
  if (grp %% 2 == 0) {
    data.frame(
      x = ggplot2:::interleave(violin.xs, violin.xmaxvs),
      y = rep(ys, each = 2), group = rep(ys, each = 2)
    )
  } else {
    data.frame(
      x = ggplot2:::interleave(violin.xminvs, violin.xs),
      y = rep(ys, each = 2), group = rep(ys, each = 2)
    )
  }
}

geom_split_violin <- function(mapping = NULL, data = NULL, stat = "ydensity", position = "identity", ..., 
                              draw_quantiles = NULL, trim = TRUE, scale = "area", na.rm = FALSE, 
                              show.legend = NA, inherit.aes = TRUE) {
  layer(data = data, mapping = mapping, stat = stat, geom = GeomSplitViolin, position = position, 
        show.legend = show.legend, inherit.aes = inherit.aes, 
        params = list(trim = trim, scale = scale, draw_quantiles = draw_quantiles, na.rm = na.rm, ...))
}

```


 

# Figure 2
## Plotting the Theoretical Max Acquisition rate
```{r, fig.width= 6, fig.height=4}

calculate_scan_rates_from_folder_3k <- function(folder_path) {
  # Get all .mzML files in the folder
  mzml_files <- list.files(folder_path, pattern = "\\.mzML$", full.names = TRUE)
  
  # Define helper function for each file
  process_file <- function(file_path) {
    # Extract filename (without path)
    filename <- basename(file_path)
    
    # Split the filename by underscores
    parts <- str_split(filename, "_", simplify = TRUE)
    
    # Parse metadata from filename
    instrument <- parts[1]
    isoWindow <- parts[2]
    inj_time <- parts[3]
    
    # Open mzML and extract metadata
    ms_data <- openMSfile(file_path)
    meta <- header(ms_data)
    
    # Take only the last 5000 scans
    last_scans <- tail(meta, 3000)
    
    # Filter for MS2 scans only
    ms2_meta <- last_scans %>% filter(msLevel == 2)
    
    total_scans <- nrow(ms2_meta)
    
    if (total_scans > 1) {
      rt_min <- min(ms2_meta$retentionTime, na.rm = TRUE)
      rt_max <- max(ms2_meta$retentionTime, na.rm = TRUE)
      rt_span <- rt_max - rt_min  # In seconds
      theoretical_scan_rate <- total_scans / rt_span  # Hz
    } else {
      rt_span <- NA
      theoretical_scan_rate <- NA
    }
    
    # Return result as a data.frame row
    data.frame(
      filename = filename,
      instrument = instrument,
      isoWindow = isoWindow,
      injectionTime = inj_time,
      totalScans = total_scans,
      retentionTimeSec = rt_span,
      theoreticalScanRateHz = theoretical_scan_rate,
      stringsAsFactors = FALSE
    )
  }
  
  # Process all files and combine into a data.frame
  results_df <- purrr::map_dfr(mzml_files, process_file)

  return(results_df)
}




calculate_scan_rates_from_folder <- function(folder_path) {
  # Get all .mzML files in the folder
  mzml_files <- list.files(folder_path, pattern = "\\.mzML$", full.names = TRUE)
  
  # Define helper function for each file
  process_file <- function(file_path) {
    # Extract filename (without path)
    filename <- basename(file_path)
    
    print(filename)
    # Split the filename by underscores
    parts <- str_split(filename, "_", simplify = TRUE)
    
    # Parse metadata from filename
    instrument <- parts[1]
    isoWindow <- parts[2]
    inj_time <- parts[3]
    
    # Open mzML and extract metadata
    ms_data <- openMSfile(file_path)
    meta <- header(ms_data)
    
    # Filter for MS2 scans only
    ms2_meta <- meta %>% filter(msLevel == 2)
    
    total_scans <- nrow(ms2_meta)
    last_rt <- max(ms2_meta$retentionTime, na.rm = TRUE)  # In seconds
    
    theoretical_scan_rate <- total_scans / last_rt  # Hz
    
    # Return result as a data.frame row
    data.frame(
      filename = filename,
      instrument = instrument,
      isoWindow = isoWindow,
      injectionTime = inj_time,
      totalScans = total_scans,
      retentionTimeSec = last_rt,
      theoreticalScanRateHz = theoretical_scan_rate,
      stringsAsFactors = FALSE
    )
  }
  
  # Process all files and combine into a data.frame
  results_df <- purrr::map_dfr(mzml_files, process_file)

  return(results_df)
}


theoretical_scan_df <- calculate_scan_rates_from_folder("../data/acquisition_rate/Acquisition_Rate_DIA_Theoretical_mzML_files/")
theoretical_scan_df$injectionTime_ms <- as.numeric(gsub("ms", "", theoretical_scan_df$injectionTime))

theoretical_scan_df$instrument[theoretical_scan_df$instrument == "Actis"] <- "Prototype"
theoretical_scan_df$instrument <- factor(theoretical_scan_df$instrument, levels = c("Prototype", "Astral"))

theoretical_scan_df$condition <- paste(theoretical_scan_df$instrument, theoretical_scan_df$isoWindow, sep = " ")
theoretical_scan_df$ScanTimePerMS2 = 1000/theoretical_scan_df$theoreticalScanRateHz
theoretical_scan_df$overhead = theoretical_scan_df$ScanTimePerMS2 - theoretical_scan_df$injectionTime_ms




```


## Fig2A: Acq. Rate
```{r, fig.height=4, fig.width=6}



# Prepare the data
filtered_df <- theoretical_scan_df %>%
  filter(!grepl("3mz", condition)) %>%
  mutate(
    instrument = case_when(
      grepl("Astral", condition) ~ "Astral",
      grepl("Prototype", condition) ~ "Prototype"
    ),
    window_size = case_when(
      grepl("2mz", condition) ~ "2 Th",
      grepl("4mz", condition) ~ "4 Th"
    ),
    linetype = ifelse(window_size == "2 Th", "solid", "dashed"),
    color_key = paste(instrument, window_size, sep = " ")
  )



# Color map by instrument and window size
color_map <- c(
  "Prototype 4 Th" = "#F4A582",     # light orange
  "Prototype 2 Th" = "#D6604D",     # dark orange
  "Astral 4 Th" = "#92C5DE",  # light blue
  "Astral 2 Th" = "#4393C3"   # dark blue
)


highlight_times <- c(1, 1.5, 2, 2.5, 3, 4, 6, 8)


proto_4mz <- filtered_df %>% filter(color_key == "Prototype 4 Th")
proto_2mz <- filtered_df %>% filter(color_key == "Prototype 2 Th")

# Astral groups
astral_4mz <- filtered_df %>% filter(color_key == "Astral 4 Th")
astral_2mz <- filtered_df %>% filter(color_key == "Astral 2 Th")
highlight_times <- c(1, 1.5, 2, 2.5, 3, 4, 6, 8)

theoretical_scan_plot = ggplot() +
  # PROTOTYPE (light → dark)
  geom_line(data = proto_4mz, aes(x = injectionTime_ms, y = theoreticalScanRateHz,
                                  color = color_key, linetype = linetype), size = 2) +
  geom_point(data = proto_4mz %>% filter(injectionTime_ms %in% highlight_times),
             aes(x = injectionTime_ms, y = theoreticalScanRateHz, color = color_key), size = 5) +

  geom_line(data = proto_2mz, aes(x = injectionTime_ms, y = theoreticalScanRateHz,
                                  color = color_key, linetype = linetype), size = 2) +
  geom_point(data = proto_2mz %>% filter(injectionTime_ms %in% highlight_times),
             aes(x = injectionTime_ms, y = theoreticalScanRateHz, color = color_key), size = 5) +

  # ASTRAL (light → dark)
  geom_line(data = astral_4mz, aes(x = injectionTime_ms, y = theoreticalScanRateHz,
                                   color = color_key, linetype = linetype), size = 2) +
  geom_point(data = astral_4mz %>% filter(injectionTime_ms %in% highlight_times),
             aes(x = injectionTime_ms, y = theoreticalScanRateHz, color = color_key), size = 5) +

  geom_line(data = astral_2mz, aes(x = injectionTime_ms, y = theoreticalScanRateHz,
                                   color = color_key, linetype = linetype), size = 2) +
  geom_point(data = astral_2mz %>% filter(injectionTime_ms %in% highlight_times),
             aes(x = injectionTime_ms, y = theoreticalScanRateHz, color = color_key), size = 5) +

  # Add your existing scales, labels, and theme here...
  scale_color_manual(values = color_map) +
  scale_linetype_identity() +
  scale_y_continuous(limits = c(80, 300), breaks = seq(100, 300, 50)) +
  scale_x_continuous(limits = c(1.5, 8.5), breaks = seq(0, 10, 2)) +
  labs(x = "Injection time (ms)", y = "Acquisition rate (Hz)", color = " ") +
  theme_minimal(base_size = 11) +
  theme(
    legend.position = "none",
    legend.title = element_blank(),
    panel.grid.major = element_line(linetype = "dashed", color = "gray80"),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5),
    axis.title = element_text(size = 22),
    axis.text = element_text(size = 20)
  )


theoretical_scan_plot

```

##Fig2B: Overhead
```{r, fig.height=4, fig.width=5}


overhead_plot = ggplot() +
  # PROTOTYPE (light → dark)
  geom_line(data = proto_4mz, aes(x = injectionTime_ms, y = overhead,
                                  color = color_key, linetype = linetype), size = 2) +
  geom_point(data = proto_4mz %>% filter(injectionTime_ms %in% highlight_times),
             aes(x = injectionTime_ms, y = overhead, color = color_key), size = 5) +

  geom_line(data = proto_2mz, aes(x = injectionTime_ms, y = overhead,
                                  color = color_key, linetype = linetype), size = 2) +
  geom_point(data = proto_2mz %>% filter(injectionTime_ms %in% highlight_times),
             aes(x = injectionTime_ms, y = overhead, color = color_key), size = 5) +

  # ASTRAL (light → dark)
  geom_line(data = astral_4mz, aes(x = injectionTime_ms, y = overhead,
                                   color = color_key, linetype = linetype), size = 2) +
  geom_point(data = astral_4mz %>% filter(injectionTime_ms %in% highlight_times),
             aes(x = injectionTime_ms, y = overhead, color = color_key), size = 5) +

  geom_line(data = astral_2mz, aes(x = injectionTime_ms, y = overhead,
                                   color = color_key, linetype = linetype), size = 2) +
  geom_point(data = astral_2mz %>% filter(injectionTime_ms %in% highlight_times),
             aes(x = injectionTime_ms, y = overhead, color = color_key), size = 5) +

  # Add your existing scales, labels, and theme here...
  scale_color_manual(values = color_map) +
  scale_linetype_identity() +
  #scale_y_continuous(limits = c(80, 300), breaks = seq(100, 300, 50)) +
  #scale_x_continuous(limits = c(1.5, 8.5), breaks = seq(0, 10, 2)) +
  labs(x = "Injection time (ms)", y = "Overhead time (ms)", color = " ") +
  theme_minimal(base_size = 11) +
  scale_x_continuous(limits = c(1.5, 8.5), breaks = seq(0, 10, 2)) +
  theme(
    legend.position = "none",
    legend.title = element_blank(),
    panel.grid.major = element_line(linetype = "dashed", color = "gray80"),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5),
    axis.title = element_text(size = 22),
    axis.text = element_text(size = 20),
  )


overhead_plot

```

##Fig2C: Cycle time
```{r, fig.height=6, fig.width=6}



process_mzML_metadata2 <- function(mzML_path, instrument, isoWindow, mass) {
  # Open mzML file and extract metadata
  ms_data <- openMSfile(mzML_path)
  ms_data_meta <- header(ms_data)
  
  # Identify MS2 scans that do NOT immediately follow MS1
  prev_lvl <- c(NA, head(ms_data_meta$msLevel, -1))
  is_after_ms1 <- (ms_data_meta$msLevel == 2 & prev_lvl == 1)
  hdr_ms2 <- ms_data_meta[ms_data_meta$msLevel == 2 & !is_after_ms1, ]
  
  # Compute scan rate and mean injection time for filtered MS2s
  last_rt <- tail(hdr_ms2$retentionTime, 1)
  n_scans <- nrow(hdr_ms2)
  scan_rate_hz <- if (last_rt > 0) n_scans / last_rt else NA
  mean_IT <- mean(hdr_ms2$injectionTime, na.rm = TRUE)
  
  # ----------------------
  # Cycle time calculation
  # ----------------------
  ms2_data <- ms_data_meta[ms_data_meta$msLevel == 2 & !is.na(ms_data_meta$precursorMZ), ]
  ms2_data <- ms2_data[order(ms2_data$retentionTime), ]
  
  delta_mz <- diff(ms2_data$precursorMZ)
  reset_points <- which(delta_mz < 0) + 1  # start of new cycle
  cycle_starts <- ms2_data$retentionTime[reset_points]
  cycle_times <- diff(cycle_starts)
  
  mean_cycle_time <- mean(cycle_times, na.rm = TRUE)
  median_cycle_time <- median(cycle_times, na.rm = TRUE)
  n_cycles <- length(cycle_times)
  
  # Refilter for all MS2s to construct final data
  #ms2_data_full <- ms_data_meta[ms_data_meta$msLevel == 2, ]
  
  result <- data.frame(
    instrument = instrument,
    isoWindow = isoWindow,
    mass = mass,
    ScanNumber = ms2_data$acquisitionNum,
    RetentionTime = ms2_data$retentionTime,
    msLevel = ms2_data$msLevel,
    PrecursorMZ = ms2_data$precursorMZ,
    ScanRateHz = scan_rate_hz,
    IonInjectionTimeMs = ms2_data$injectionTime,
    Intensity = ms2_data$totIonCurrent,
    Ions = (ms2_data$injectionTime * ms2_data$totIonCurrent) / 1000,
    MeanInjectionTimeMs = mean_IT,
    MeanCycleTimeSec = mean_cycle_time,
    MedianCycleTimeSec = median_cycle_time,
    NumCycles = n_cycles,
    ScansPerCycle = if (n_cycles > 0) n_scans / n_cycles else NA,
    stringsAsFactors = FALSE
  )
  
  # Close file connection
  close(ms_data)
  return(result)
}





# List all mzML files in the folder
theoretical_mzml_files <- list.files("../data/acquisition_rate/Acquisition_Rate_DIA_Theoretical_mzML_files/", pattern = "\\.mzML$", full.names = TRUE)



results_list <- lapply(theoretical_mzml_files, function(file_path) {

    filename <- basename(file_path)
    
    print(filename)
    
    # Split the filename by underscores
    parts <- str_split(filename, "_", simplify = TRUE)
    
    # Parse metadata from filename
    instrument <- parts[1]
    isoWindow <- parts[2]
    inj_time <- parts[3]
    mass = 0
  print(file_path)
  process_mzML_metadata2(file_path, instrument, isoWindow, inj_time)
})

# Combine into one data frame
all_metadata_theoretical <- do.call(rbind, results_list)



cleaned_metadata_theoretical <- all_metadata_theoretical %>%
  distinct(instrument, isoWindow, mass, .keep_all = TRUE)


#######################
#######################



cleaned_metadata_theoretical$injectionTime_ms <- as.numeric(gsub("ms", "", cleaned_metadata_theoretical$mass))

cleaned_metadata_theoretical$instrument[cleaned_metadata_theoretical$instrument == "Actis"] <- "Prototype"
cleaned_metadata_theoretical$instrument <- factor(cleaned_metadata_theoretical$instrument, levels = c("Prototype", "Astral"))

cleaned_metadata_theoretical$condition <- paste(cleaned_metadata_theoretical$instrument, cleaned_metadata_theoretical$isoWindow, sep = " ")



color_map <- c(
  "Prototype 4 Th" = "#F4A582",
  "Prototype 2 Th" = "#D6604D",
  "Astral 4 Th"    = "#92C5DE",
  "Astral 2 Th"    = "#4393C3"
)



# Prepare the data
filtered_df_cyc <- cleaned_metadata_theoretical %>%
  filter(!grepl("3mz", condition)) %>%
  mutate(
    instrument = case_when(
      grepl("Astral", condition) ~ "Astral",
      grepl("Prototype", condition) ~ "Prototype"
    ),
    window_size = case_when(
      grepl("2mz", condition) ~ "2 Th",
      grepl("4mz", condition) ~ "4 Th"
    ),
    linetype = ifelse(window_size == "2 Th", "solid", "dashed"),
    color_key = paste(instrument, window_size, sep = " ")
  )


proto_4mz_cyc <- filtered_df_cyc %>% filter(color_key == "Prototype 4 Th")
proto_2mz_cyc <- filtered_df_cyc %>% filter(color_key == "Prototype 2 Th")

# Astral groups
astral_4mz_cyc <- filtered_df_cyc %>% filter(color_key == "Astral 4 Th")
astral_2mz_cyc <- filtered_df_cyc %>% filter(color_key == "Astral 2 Th")

highlight_times <- c(1, 1.5, 2, 2.5, 3, 4, 6, 8)



theory_cycle_plot =  ggplot() +
  # PROTOTYPE (light → dark)
  geom_line(data = proto_4mz_cyc, aes(x = injectionTime_ms, y = MeanCycleTimeSec,
                                  color = color_key, linetype = linetype), size = 2) +
  geom_point(data = proto_4mz_cyc %>% filter(injectionTime_ms %in% highlight_times),
             aes(x = injectionTime_ms, y = MeanCycleTimeSec, color = color_key), size = 5) +

  geom_line(data = proto_2mz_cyc, aes(x = injectionTime_ms, y = MeanCycleTimeSec,
                                  color = color_key, linetype = linetype), size = 2) +
  geom_point(data = proto_2mz_cyc %>% filter(injectionTime_ms %in% highlight_times),
             aes(x = injectionTime_ms, y = MeanCycleTimeSec, color = color_key), size = 5) +

  # ASTRAL (light → dark)
  geom_line(data = astral_4mz_cyc, aes(x = injectionTime_ms, y = MeanCycleTimeSec,
                                   color = color_key, linetype = linetype), size = 2) +
  geom_point(data = astral_4mz_cyc %>% filter(injectionTime_ms %in% highlight_times),
             aes(x = injectionTime_ms, y = MeanCycleTimeSec, color = color_key), size = 5) +

  geom_line(data = astral_2mz_cyc, aes(x = injectionTime_ms, y = MeanCycleTimeSec,
                                   color = color_key, linetype = linetype), size = 2) +
  geom_point(data = astral_2mz_cyc %>% filter(injectionTime_ms %in% highlight_times),
             aes(x = injectionTime_ms, y = MeanCycleTimeSec, color = color_key), size = 5) +

  # Add your existing scales, labels, and theme here...
  scale_color_manual(values = color_map) +
  scale_linetype_identity() +
  #scale_y_continuous(limits = c(80, 300), breaks = seq(100, 300, 50)) +
  #scale_x_continuous(limits = c(1.5, 8.5), breaks = seq(0, 10, 2)) +
  labs(x = "Injection time (ms)", y = "Cycle time (sec)", color = " ") +
  theme_minimal(base_size = 11) +
  scale_x_continuous(limits = c(1.5, 8.5), breaks = seq(0, 10, 2)) +
  ylim(0, 1.6)+
  theme(
    legend.position = "none",
    legend.title = element_blank(),
    panel.grid.major = element_line(linetype = "dashed", color = "gray80"),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5),
    axis.title = element_text(size = 22),
    axis.text = element_text(size = 20),
  )

theory_cycle_plot

```






## HeLa processing data
### Opening/Writing the mzML files
Data should be under "Acquisition_rate" > "hela_mzML" in Panorama public files.
- Remember to place directories in the appropriate locations!
- Only run this if the csv are unavailable since it takes a long time to run. 
```{r}


process_mzML_metadata <- function(mzML_path, instrument, isoWindow, mass) {
  # Open mzML file and extract metadata
  ms_data <- openMSfile(mzML_path)
  ms_data_meta <- header(ms_data)
  
  # Identify MS2 scans that do NOT immediately follow MS1
  prev_lvl <- c(NA, head(ms_data_meta$msLevel, -1))
  is_after_ms1 <- (ms_data_meta$msLevel == 2 & prev_lvl == 1)
  hdr_ms2 <- ms_data_meta[ms_data_meta$msLevel == 2 & !is_after_ms1, ]
  
  # Compute scan rate and mean injection time for filtered MS2s
  last_rt <- tail(hdr_ms2$retentionTime, 1)
  n_scans <- nrow(hdr_ms2)
  scan_rate_hz <- if (last_rt > 0) n_scans / last_rt else NA
  mean_IT <- mean(hdr_ms2$injectionTime, na.rm = TRUE)
  
  # ----------------------
  # Cycle time calculation
  # ----------------------
  ms2_data <- ms_data_meta[ms_data_meta$msLevel == 2 & !is.na(ms_data_meta$precursorMZ), ]
  ms2_data <- ms2_data[order(ms2_data$retentionTime), ]
  
  delta_mz <- diff(ms2_data$precursorMZ)
  reset_points <- which(delta_mz < 0) + 1  # start of new cycle
  cycle_starts <- ms2_data$retentionTime[reset_points]
  cycle_times <- diff(cycle_starts)
  
  mean_cycle_time <- mean(cycle_times, na.rm = TRUE)
  median_cycle_time <- median(cycle_times, na.rm = TRUE)
  n_cycles <- length(cycle_times)
  
  # Refilter for all MS2s to construct final data
if (!"msLevel" %in% colnames(ms_data_meta)) {
  stop("msLevel column not found in mzML metadata.")
}

ms2_data_full <- ms_data_meta[ms_data_meta$msLevel == 2, ]

if (nrow(ms2_data_full) == 0) {
  stop("No MS2 scans found in the mzML file.")
}
  
  ms2_data_full <- ms_data_meta[ms_data_meta$msLevel == 2, ]
  
  
  
  result <- data.frame(
    instrument = instrument,
    isoWindow = isoWindow,
    mass = mass,
    ScanNumber = ms2_data_full$acquisitionNum,
    RetentionTime = ms2_data_full$retentionTime,
    msLevel = ms2_data_full$msLevel,
    PrecursorMZ = ms2_data_full$precursorMZ,
    ScanRateHz = scan_rate_hz,
    IonInjectionTimeMs = ms2_data_full$injectionTime,
    Intensity = ms2_data_full$totIonCurrent,
    Ions = (ms2_data_full$injectionTime * ms2_data_full$totIonCurrent) / 1000,
    MeanInjectionTimeMs = mean_IT,
    MeanCycleTimeSec = mean_cycle_time,
    MedianCycleTimeSec = median_cycle_time,
    NumCycles = n_cycles,
    ScansPerCycle = if (n_cycles > 0) n_scans / n_cycles else NA,
    stringsAsFactors = FALSE
  )
  
  # Close file connection
  close(ms_data)
  return(result)
}




library(stringr)
library(dplyr)

base_dir <- "../data/acquisition_rate/hela_mzML/"

files <- list.files(path = base_dir, pattern = "\\.mzML$", full.names = FALSE)


file_info <- str_match(
  files,
  "^(Actis|Astral)_\\d+_\\d+_\\d+_(\\d+)ng_(\\d+)mzIso_(\\d+)msIT_\\d+agc_HeLa_(\\d+)\\.mzML$"
)


df_hela_meta <- data.frame(
  instrument = file_info[,2],
  mass = as.numeric(file_info[,3]),
  iso = as.numeric(file_info[,4]),
  it = as.numeric(file_info[,5]),
  replicate = as.numeric(file_info[,6]),
  filename = files,
  stringsAsFactors = FALSE
)


all_results <- list()

for (i in 1:nrow(df_hela_meta)) {
  row <- df[i, ]
  file_path <- file.path(base_dir, row$filename)
  
  message("Processing file ", i, " of ", nrow(df), ": ", row$filename)
  
  tryCatch({
    result <- process_mzML_metadata(
      mzML_path = file_path,
      instrument = row$instrument,
      isoWindow = paste0(row$iso, "mz ", row$it, "msIT"),
      mass = row$mass,
      replicate = row$replicate
    )
    all_results[[i]] <- result
  }, error = function(e) {
    message("Error processing ", row$filename, ": ", e$message)
  })
}

results_hela_acq_cyc <- bind_rows(all_results)

# Save as CSV
output_file_hela_acq_cyc <- "../data/acquisition_rate/hela_files/HeLa_ms2_metadata_results.csv"
write.csv(output_file_hela_acq_cyc, output_file, row.names = FALSE)


```



```{r}

results_hela_acq_cyc <- fread("../data/acquisition_rate/hela_files/HeLa_ms2_metadata_results.csv")
# Convert to data.table and rename Actis to Prototype
dt_all_acq_cyc <- as.data.table(results_hela_acq_cyc)
dt_all_acq_cyc$instrument[dt_all_acq_cyc$instrument == "Actis"] <- "Prototype"

# Summarize across replicates
dt_summary <- dt_all_acq_cyc %>%
  group_by(instrument, isoWindow, mass, replicate) %>%
  summarise(
    ScanRateHz = mean(as.numeric(ScanRateHz), na.rm = TRUE),
    MeanCycleTimeSec = mean(as.numeric(MeanCycleTimeSec), na.rm = TRUE)
  ) %>%
  group_by(instrument, isoWindow, mass) %>%
  summarise(
    mean_scan_rate = mean(ScanRateHz, na.rm = TRUE),
    sd_scan_rate = sd(ScanRateHz, na.rm = TRUE),
    mean_cycle_time = mean(MeanCycleTimeSec, na.rm = TRUE),
    sd_cycle_time = sd(MeanCycleTimeSec, na.rm = TRUE)
  ) %>%
  ungroup()

# Format the data
dt_summary$mass <- as.numeric(as.character(dt_summary$mass))
dt_summary$isoWindow <- gsub("mz", "Th", dt_summary$isoWindow)
dt_summary$isoWindow <- recode(dt_summary$isoWindow,
    "2Th 4msIT" = "2 Th with 4 ms IT",
    "3Th 6msIT" = "3 Th with 6 ms IT",
    "4Th 8msIT" = "4 Th with 8 ms IT")

dt_summary$instrument <- factor(dt_summary$instrument, levels = c("Astral", "Prototype"))



```


##Fig2D: HeLa Acq. rate
```{r, fig.width= 7, fig.height=6}


acquisition_rate_plot <- ggplot(dt_summary, aes(x = mass, y = mean_scan_rate, color = isoWindow)) +
  geom_line(size = 2, alpha = 1) +
  geom_point(size = 5) +
  geom_errorbar(aes(ymin = mean_scan_rate - sd_scan_rate, 
                    ymax = mean_scan_rate + sd_scan_rate), 
                width = 20, size = 0.8) +
  facet_wrap(~instrument) +
  labs(
    x = "Input HeLa mass (ng)",
    y = "Acquisition rate (Hz)",
    color = "Isolation Window"
  ) +   scale_color_manual(values = my_colors) +
  theme_bw()  +   theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    legend.text = element_text(size = 18),      # <-- Increase text size
    panel.grid.major = element_line(linetype = "dashed", color = "gray80"),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5),
    axis.title = element_text(size = 22),
    axis.text = element_text(size = 20),
      strip.text = element_text(size = 20),  
    axis.text.x = element_text(angle = 45, hjust = 1),
  )


acquisition_rate_plot


```




## Fig2E: HeLa cycle time
```{r, fig.width= 7, fig.height=6}

#dt_mzML_clean$mass <- as.numeric(as.character(dt_mzML_clean$mass))


cycle_time_plot = ggplot(dt_summary, aes(x = mass, y = mean_cycle_time, color = isoWindow)) +
  geom_line(size = 2, alpha = 1) +
  geom_point(size = 5) +
  xlim(0, 2000)+
  facet_wrap(.~instrument) +
  labs(x = "Input HeLa mass (ng)",
       y = "Cycle time (sec)",
       color = "Isolation Window") +
  scale_color_manual(values = my_colors) +
  theme_bw()  +    theme(
    legend.position = "bottom",
    legend.text = element_text(size = 18),      # <-- Increase text size
    legend.title = element_blank(),
    panel.grid.major = element_line(linetype = "dashed", color = "gray80"),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5),
    axis.title = element_text(size = 22),
    axis.text = element_text(size = 20),
      strip.text = element_text(size = 20),  
    axis.text.x = element_text(angle = 45, hjust = 1),
  )

cycle_time_plot

```




## Full plot Fig2
```{r, fig.width= 14, fig.height=12, warning=FALSE, message=FALSE}


Figure2ABC <- (
  theoretical_scan_plot + overhead_plot + theory_cycle_plot
) +
  plot_layout(guides = "collect") &
  theme(
    legend.position = "bottom",
    legend.text = element_text(size = 18),
    legend.title = element_text(size = 16), 
    legend.key.size = unit(1.2, "lines"),
  )

#Figure2ABC


Figure2DE = (acquisition_rate_plot | cycle_time_plot) + 
  plot_layout(heights = c(1, 1), guides = "collect") &   theme(
    legend.position = "bottom",
    legend.text = element_text(size = 18),
    legend.title = element_blank(),
    legend.key.size = unit(1.2, "lines")
  )

fig2_final = (Figure2ABC / Figure2DE) + plot_annotation(tag_levels = "A") & 
  theme(plot.tag = element_text(size = 24, face = "bold"))

fig2_final

ggsave("../figures/Figure_2.pdf", plot = fig2_final, width = 14, height = 12, dpi = 1200)


```




## Figure S1: Injection time
```{r, fig.height=10, fig.width=12}


combined_200ng_mzML = read.csv("../data/acquisition_rate/hela_files/combined_200ng_mzML.csv")
combined_500ng_mzML = read.csv("../data/acquisition_rate/hela_files/combined_500ng_mzML.csv")
combined_1000ng_mzML = read.csv("../data/acquisition_rate/hela_files/combined_1000ng_mzML.csv")
combined_2000ng_mzML = read.csv("../data/acquisition_rate/hela_files/combined_2000ng_mzML.csv")


combined_mzML_df = bind_rows(combined_200ng_mzML,
                        combined_500ng_mzML,
                        combined_1000ng_mzML,
                        combined_2000ng_mzML)


dt_mzML <- as.data.table(combined_mzML_df)

dt_mzML$instrument[dt_mzML$instrument == "Actis"] <- "Prototype"


dt_mzML_IT = dt_mzML
dt_mzML_IT$instrument <- factor(dt_mzML$instrument, levels = c("Prototype", "Astral"))
dt_mzML_IT$mass <- paste0(as.character(dt_mzML$mass), "ng")
dt_mzML_IT$mass <- factor(dt_mzML_IT$mass, levels = c("200ng", "500ng", "1000ng", "2000ng"))


dt_mzML_IT$isoWindow <- ifelse(grepl("2mz 4msIT", dt_mzML_IT$isoWindow, ignore.case = TRUE), "2 Th with 4 ms IT",
                     ifelse(grepl("3mz 6msIT", dt_mzML_IT$isoWindow, ignore.case = TRUE), "3 Th with 6 ms IT",
                     ifelse(grepl("4mz 8msIT", dt_mzML_IT$isoWindow, ignore.case = TRUE), "4 Th with 8 ms IT",NA)))





df_mzML_2mz <- dt_mzML_IT %>%
  filter(isoWindow == "2 Th with 4 ms IT") 

df_mzML_3mz <- dt_mzML_IT %>%
  filter(isoWindow == "3 Th with 6 ms IT") 

df_mzML_4mz <- dt_mzML_IT %>%
  filter(isoWindow == "4 Th with 8 ms IT") 




make_supp_figure1 <- function(df_2mz, df_3mz, df_4mz) {
  
  make_histogram_plot <- function(df, title_text) {
    ggplot(df, aes(x = IonInjectionTimeMs, color = instrument, fill = instrument)) +
      geom_histogram(binwidth = 0.25, position = "identity", alpha = 0.3) +
      facet_wrap(~mass, ncol = 5) +
      scale_x_continuous(
        limits = c(1, 10),
        breaks = seq(1, 10, by = 2)
      ) +
    scale_y_log10(limits = c(1, 10^6),
    breaks = trans_breaks("log10", function(x) 10^x),
    labels = trans_format("log10", math_format(10^.x)),
       expand = c(0, 0)) +

      labs(
        title = title_text,
        x = "Injection Time (ms)",
        y = "Number of spectra"
      ) +
      theme_bw() +
      theme(
        text = element_text(size = 14), 
        axis.title = element_text(size = 16),  
        axis.text = element_text(size = 13),   
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 13),
        strip.text = element_text(size = 14)
      )
  }

  IT_2mz_plot <- make_histogram_plot(df_2mz, "2 Th window with 4 ms IT")
  IT_3mz_plot <- make_histogram_plot(df_3mz, "3 Th window with 6 ms IT")
  IT_4mz_plot <- make_histogram_plot(df_4mz, "4 Th window with 8 ms IT")

  SuppFigure1 <- (IT_2mz_plot / IT_3mz_plot / IT_4mz_plot) + 
    plot_layout(guides = "collect") +
    plot_annotation(tag_levels = "A") &
    theme(
      legend.position = "bottom",
      plot.tag = element_text(size = 18, face = "bold")
    )
  
  return(SuppFigure1)
}



SuppFigure1_made <- make_supp_figure1(df_mzML_2mz, df_mzML_3mz, df_mzML_4mz)


SuppFigure1 = SuppFigure1_made + plot_annotation(tag_levels = "A") & 
  theme(plot.tag = element_text(size = 20, face = "bold"))

SuppFigure1

ggsave("../figures/Figure_S1.pdf", plot = SuppFigure1, width = 12, height = 10, dpi = 700)

```



# Figure S2: Reviewer Peptide/Protein Gained at lower abundance
## FigS2A: Peptides
```{r}


df_pep_quant_2000ng = read.csv("../data/hela_isolation_window/CV_data/peptide_CV_2000ng.csv")
df_pep_quant_200ng = read.csv("../data/hela_isolation_window/CV_data/peptide_CV_200ng.csv")



make_long_df <- function(df, mass_ng) {
  df %>%
    select(Protein, Peptide, Precursor, contains("Actis")) %>%
    select(-contains("CV")) %>%
    mutate(across(everything(), ~na_if(.x, "#N/A"))) %>%
    pivot_longer(
      cols = contains("Actis"),
      names_to = "Condition",
      values_to = "Abundance"
    ) %>%
    mutate(
      Mass_ng = mass_ng,
      IsoWin_IT = case_when(
        grepl("2mz", Condition) ~ "2mz",
        grepl("3mz", Condition) ~ "3mz",
        grepl("4mz", Condition) ~ "4mz",
        TRUE ~ NA_character_
      )
    ) %>%
    filter(!is.na(IsoWin_IT)) %>%
    mutate(Abundance = as.numeric(Abundance))
}

df_2000_long <- make_long_df(df_pep_quant_2000ng, "2000ng")
df_200_long  <- make_long_df(df_pep_quant_200ng, "200ng")



datasets <- bind_rows(df_2000_long, df_200_long) %>%
  group_by(Mass_ng, IsoWin_IT) %>%
  group_split() %>%
  set_names(paste0(map_chr(., ~unique(.$Mass_ng)), "_", map_chr(., ~unique(.$IsoWin_IT))))


compare_window <- function(df_2000, df_200) {
  peps_2000 <- df_2000 %>% filter(!is.na(Abundance)) %>% pull(Peptide) %>% unique()
  peps_200  <- df_200 %>% filter(!is.na(Abundance)) %>% pull(Peptide) %>% unique()
  
  shared      <- intersect(peps_2000, peps_200)
  unique_2000 <- setdiff(peps_2000, peps_200)
  
  tibble(
    Peptide = c(shared, unique_2000),
    Status  = c(rep("Shared", length(shared)),
                rep("Unique to 2000 ng", length(unique_2000)))
  )
}


windows <- c("2mz", "3mz", "4mz")
status_list <- map(windows, ~compare_window(
  datasets[[paste0("2000ng_", .x)]],
  datasets[[paste0("200ng_", .x)]]
))

names(status_list) <- windows


status_df <- bind_rows(
  lapply(windows, function(w) {
    status_list[[w]] %>% mutate(IsoWin_IT = w)
  })
)



ranked_data <- bind_rows(
  datasets$`2000ng_2mz`,
  datasets$`2000ng_3mz`,
  datasets$`2000ng_4mz`
) %>%
  left_join(status_df, by = c("Peptide", "IsoWin_IT")) %>%
  mutate(Status = ifelse(is.na(Status), "Unique to 2000 ng", Status)) %>%
  group_by(IsoWin_IT) %>%
  mutate(Rank = rank(-Abundance, ties.method = "first")) %>%
  ungroup()


ranked_data %>%
  filter(Status == "Unique to 2000 ng") %>%
  group_by(IsoWin_IT) %>%
  summarise(n_unique = n())



iso_labels <- c(
  "2mz" = "2 Th with 4 ms IT",
  "3mz" = "3 Th with 6 ms IT",
  "4mz" = "4 Th with 8 ms IT"
)



# Plot ranked peptides faceted by isolation window
pep_rank_plt = ggplot(ranked_data, aes(x = Rank, y = Abundance, color = Status)) +
  geom_point(size = 3, alpha = 0.1) +
  scale_y_log10(
    breaks = trans_breaks("log10", function(x) 10^x),
    labels = trans_format("log10", math_format(10^.x))
  ) +
  scale_x_continuous(
    breaks = scales::pretty_breaks(n = 4),
    limits = c(1, NA)
  ) +
  scale_color_manual(
    values = c("Unique to 2000 ng" = "red",
               "Shared" = "black")
  ) +
  labs(
    x = "Rank (by abundance)",
    y = "Peptide abundance",
    color = ""
  ) +
  guides(color = guide_legend(override.aes = list(alpha = 0.5, size = 3))) +   # <-- full opacity legend

  facet_wrap(~IsoWin_IT, labeller = labeller(IsoWin_IT = iso_labels)) +
  theme_bw() +
  theme(
    text = element_text(size = 16),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
    legend.text = element_text(size = 12),
    strip.text = element_text(size = 14),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.title = element_blank(),
    legend.position = "bottom"
  )

```

## FigS2B: Proteins
```{r}



df_prot_quant_2000ng = read.csv("../data/hela_isolation_window/CV_data/protein_CV_2000ng_uncalculated.csv")
df_prot_quant_200ng = read.csv("../data/hela_isolation_window/CV_data/protein_CV_200ng_uncalculated.csv")




make_prot_long <- function(df, mass_ng) {
  df %>%
    select(Protein, Protein.Description, Protein.Gene, contains("Actis")) %>%
    mutate(across(everything(), ~na_if(.x, "#N/A"))) %>%
    pivot_longer(
      cols = contains("Actis"),
      names_to = "Condition",
      values_to = "Abundance"
    ) %>%
    mutate(
      Abundance = as.numeric(Abundance),
      Mass_ng = mass_ng,
      IsoWin_IT = case_when(
        grepl("2mzIso", Condition) ~ "2mz",
        grepl("3mzIso", Condition) ~ "3mz",
        grepl("4mzIso", Condition) ~ "4mz",
        TRUE ~ NA_character_
      ),
      Replicate = case_when(
        grepl("_01.Sum", Condition) ~ 1,
        grepl("_02.Sum", Condition) ~ 2,
        grepl("_03.Sum", Condition) ~ 3,
        TRUE ~ NA_real_
      )
    ) %>%
    filter(!is.na(IsoWin_IT))
}

df_prot_2000_long <- make_prot_long(df_prot_quant_2000ng, "2000ng")
df_prot_200_long  <- make_prot_long(df_prot_quant_200ng,  "200ng")

# ------------------------------
# Step 3: Average replicates per protein × isolation window
# ------------------------------
df_prot_2000_avg <- df_prot_2000_long %>%
  group_by(Protein, IsoWin_IT) %>%
  filter(any(!is.na(Abundance))) %>%  # keep only groups with at least one non-NA
  summarise(Abundance = mean(Abundance, na.rm = TRUE), .groups = "drop")

df_prot_200_avg <- df_prot_200_long %>%
  group_by(Protein, IsoWin_IT) %>%
  filter(any(!is.na(Abundance))) %>%  # keep only groups with at least one non-NA
  summarise(Abundance = mean(Abundance, na.rm = TRUE), .groups = "drop")

windows <- c("2mz", "3mz", "4mz")
prot_datasets <- list(
  "2000ng_2mz" = df_prot_2000_avg %>% filter(IsoWin_IT == "2mz"),
  "2000ng_3mz" = df_prot_2000_avg %>% filter(IsoWin_IT == "3mz"),
  "2000ng_4mz" = df_prot_2000_avg %>% filter(IsoWin_IT == "4mz"),
  "200ng_2mz"  = df_prot_200_avg  %>% filter(IsoWin_IT == "2mz"),
  "200ng_3mz"  = df_prot_200_avg  %>% filter(IsoWin_IT == "3mz"),
  "200ng_4mz"  = df_prot_200_avg  %>% filter(IsoWin_IT == "4mz")
)

# ------------------------------
# Step 5: Function to compute shared / unique proteins per window
# ------------------------------
compare_protein_window <- function(df_2000, df_200) {
  prot_2000 <- df_2000 %>% filter(!is.na(Abundance)) %>% pull(Protein) %>% unique()
  prot_200  <- df_200 %>% filter(!is.na(Abundance)) %>% pull(Protein) %>% unique()
  
  shared      <- intersect(prot_2000, prot_200)
  unique_2000 <- setdiff(prot_2000, prot_200)
  
  tibble(
    Protein = c(shared, unique_2000),
    Status  = c(rep("Shared", length(shared)),
                rep("Unique to 2000 ng", length(unique_2000)))
  )
}

# ------------------------------
# Step 6: Generate status tables for each window
# ------------------------------
prot_status_list <- map(windows, ~compare_protein_window(
  prot_datasets[[paste0("2000ng_", .x)]],
  prot_datasets[[paste0("200ng_", .x)]]
))
names(prot_status_list) <- windows

prot_status_df <- bind_rows(
  lapply(windows, function(w) {
    prot_status_list[[w]] %>% mutate(IsoWin_IT = w)
  })
)

# ------------------------------
# Step 7: Combine with 2000ng data and rank
# ------------------------------
ranked_prot_data <- bind_rows(
  prot_datasets$`2000ng_2mz`,
  prot_datasets$`2000ng_3mz`,
  prot_datasets$`2000ng_4mz`
) %>%
  left_join(prot_status_df, by = c("Protein", "IsoWin_IT")) %>%
  mutate(Status = ifelse(is.na(Status), "Unique to 2000 ng", Status)) %>%
  group_by(IsoWin_IT) %>%
  mutate(Rank = rank(-Abundance, ties.method = "first")) %>%
  ungroup()

# ------------------------------
# Step 8: Optional: Plot protein abundances ranked per window
# ------------------------------
iso_labels <- c(
  "2mz" = "2 Th with 4 ms IT",
  "3mz" = "3 Th with 6 ms IT",
  "4mz" = "4 Th with 8 ms IT"
)

prot_rank_plt = ggplot(ranked_prot_data, aes(x = Rank, y = Abundance, color = Status)) +
  geom_point(size = 3, alpha = 0.1) +
  scale_y_log10(
    breaks = trans_breaks("log10", function(x) 10^x),
    labels = trans_format("log10", math_format(10^.x))
  ) +  scale_x_continuous(breaks = scales::pretty_breaks(n = 4), limits = c(1, NA)) +
  scale_color_manual(values = c("Unique to 2000 ng" = "red", "Shared" = "black")) +
  facet_wrap(~IsoWin_IT, labeller = labeller(IsoWin_IT = iso_labels)) +
  labs(x = "Rank (by abundance)", y = "Protein abundance", color = "") +
  guides(color = guide_legend(override.aes = list(alpha = 0.5, size = 3))) +   # <-- full opacity legend
  theme_bw() +
  theme(
    text = element_text(size = 16),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
    legend.text = element_text(size = 12),
    strip.text = element_text(size = 14),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.title = element_blank(),
    legend.position = "bottom"
  )


```



## FigS2AB: Full plot
```{r, fig.width=10, fig.height=8}
#pep_rank_plt + prot_rank_plt


supp_fig_2 <- (pep_rank_plt / prot_rank_plt) + 
  plot_layout(ncol = 1, guides = "collect") + 
  plot_annotation(tag_levels = "A") & 
  theme(
    legend.position = "bottom",
    legend.text = element_text(size = 16),      # <-- Increase text size
    legend.title = element_blank(),
    legend.key.size = unit(1.2, "lines"),
     plot.tag = element_text(size = 20, face = "bold")
  )



supp_fig_2

ggsave("../figures/supp_Figure_2.pdf", plot = supp_fig_2, width = 10, height = 8, dpi = 700)




```




# Figure 3
##Protein/Precursor Detections plot
```{r, fig.width= 10, fig.height=15}


my_colors_Th <- c( "#7CA0D4","#DE757B", "#8BA56F","#A48AD3", 
              "#2B8AAE", "#624894","#E995EB", "#BADE86",
               "#073F80", "#40007F", "#80003F", "#0A522A")


my_colors = c( "#4393C3", "#D6604D")



df_prot_pep_ids = read_tsv("../data/hela_isolation_window/DIANN_search/report.stats.tsv")

df_prot_pep_ids$File.Name <- basename(df_prot_pep_ids$File.Name)

df_prot_pep_ids1 <- df_prot_pep_ids %>%
  filter(str_detect(File.Name, "Actis"))


df_prot_pep_ids$IsoWindow <- ifelse(grepl("2mzIso", df_prot_pep_ids$File.Name, ignore.case = TRUE), "2 Th with 4 ms IT",
                     ifelse(grepl("3mzIso", df_prot_pep_ids$File.Name, ignore.case = TRUE), "3 Th with 6 ms IT",
                     ifelse(grepl("4mzIso", df_prot_pep_ids$File.Name, ignore.case = TRUE), "4 Th with 8 ms IT",NA)))

df_prot_pep_ids$Instrument <- ifelse(grepl("Astral", df_prot_pep_ids$File.Name, ignore.case = TRUE), "Astral",
                     ifelse(grepl("Actis", df_prot_pep_ids$File.Name, ignore.case = TRUE), "Prototype",NA))


df_prot_pep_ids$Mass <- ifelse(grepl("50ng", df_prot_pep_ids$File.Name, ignore.case = TRUE), "50",
                     ifelse(grepl("200ng", df_prot_pep_ids$File.Name, ignore.case = TRUE), "200",
                     ifelse(grepl("500ng", df_prot_pep_ids$File.Name, ignore.case = TRUE), "500",
                     ifelse(grepl("1000ng", df_prot_pep_ids$File.Name, ignore.case = TRUE), "1000",
                     ifelse(grepl("2000ng", df_prot_pep_ids$File.Name, ignore.case = TRUE), "2000",NA)))))



df_prot_pep_ids$Mass = as.numeric(df_prot_pep_ids$Mass)

df_prot_pep_ids <- df_prot_pep_ids %>%
  filter(Mass != 50)



df_summary <- df_prot_pep_ids %>%
  group_by(Instrument, IsoWindow, Mass) %>%
  summarise(
    mean_proteins = mean(Proteins.Identified, na.rm = TRUE),
    sd_proteins = sd(Proteins.Identified, na.rm = TRUE),
    mean_precursors = mean(Precursors.Identified, na.rm = TRUE),
    sd_precursors = sd(Precursors.Identified, na.rm = TRUE),
    .groups = "drop"
  )




# Run t-test
ttest_results_prot <- df_prot_pep_ids %>%
  filter(!is.na(Proteins.Identified), !is.na(Instrument)) %>%
  group_by(Mass, IsoWindow) %>%
  filter(n_distinct(Instrument) == 2) %>%
  summarise(
    p_value = tryCatch(
      t.test(Proteins.Identified ~ Instrument)$p.value,
      error = function(e) NA
    ),
    .groups = "drop"
  ) %>%
  mutate(
    sig_label = case_when(
      is.na(p_value) ~ "NA",
      p_value < 0.001 ~ "***",
      p_value < 0.01 ~ "**",
      p_value < 0.05 ~ "*",
      TRUE ~ ""
    )
  )


ttest_results_precur <- df_prot_pep_ids %>%
  filter(!is.na(Precursors.Identified), !is.na(Instrument)) %>%
  group_by(Mass, IsoWindow) %>%
  filter(n_distinct(Instrument) == 2) %>%
  summarise(
    p_value = tryCatch(
      t.test(Precursors.Identified ~ Instrument)$p.value,
      error = function(e) NA
    ),
    .groups = "drop"
  ) %>%
  mutate(
    sig_label = case_when(
      is.na(p_value) ~ "NA",
      p_value < 0.001 ~ "***",
      p_value < 0.01 ~ "**",
      p_value < 0.05 ~ "*",
      TRUE ~ ""
    )
  )


```


## Table S1, S2
```{r}

df_summary

```


## Original Full plot Fig3 
```{r, fig.width= 10, fig.height=15}


df_summary <- df_summary %>%
  mutate(IsoWindow = recode(IsoWindow,
    "2Th with 4msIT" = "2 Th with 4 ms IT",
    "3Th with 6msIT" = "3 Th with 6 ms IT",
    "4Th with 8msIT" = "4 Th with 8 ms IT"
  ))


protein_plt = ggplot(df_summary, aes(x = Mass, y = mean_proteins, color = Instrument)) +
  geom_line(size = 2, alpha = 1) +
  geom_point(size = 5) +
  geom_errorbar(aes(ymin = mean_proteins - sd_proteins,
                    ymax = mean_proteins + sd_proteins),
                width = 50,   linewidth = 1.2) +

  scale_color_manual(values = my_colors) +

  facet_wrap(~ IsoWindow) +
  labs(x = "Input HeLa mass (ng)",
       y = "Proteins detected",
       color = "Instrument") +
  scale_y_continuous(
    limits = c(8800, 9900),
    breaks = seq(8900, 9900, by = 500)
  ) +
  xlim(0, 2000)+
  theme_bw() + theme(
    legend.position = "none",
    legend.title = element_blank(),
    panel.grid.major = element_line(linetype = "dashed", color = "gray80"),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5),
    axis.title = element_text(size = 22),
    axis.text = element_text(size = 20),
      strip.text = element_text(size = 20),  
    axis.text.x = element_text(angle = 45, hjust = 1),
  )


precursor_plt = ggplot(df_summary, aes(x = Mass, y = mean_precursors, color = Instrument)) +
  geom_line(size = 2, alpha = 1) +
  geom_point(size = 5) +
  geom_errorbar(aes(ymin = mean_precursors - sd_precursors,
                    ymax = mean_precursors + sd_precursors),
                width = 50, linewidth = 1.2) +

  scale_color_manual(values = my_colors) +

  facet_wrap(~ IsoWindow) +
  labs(x = "Input HeLa mass (ng)",
       y = "Precursors detected",
       color = "Instrument") +
  xlim(0, 2000)+
  scale_y_continuous(
    limits = c(157500, 240000),
    breaks = seq(160000, 240000, by = 20000)
  ) +
  theme_bw() + theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    panel.grid.major = element_line(linetype = "dashed", color = "gray80"),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5),
    axis.title = element_text(size = 22),
    axis.text = element_text(size = 20),
      strip.text = element_text(size = 20),  
    axis.text.x = element_text(angle = 45, hjust = 1),
  )


figure3 <- (precursor_plt / protein_plt) + 
  plot_layout(ncol = 1, guides = "collect") + 
  plot_annotation(tag_levels = "A") & 
  theme(
    legend.position = "bottom",
    legend.text = element_text(size = 20),      # <-- Increase text size
    legend.title = element_blank(),
    legend.key.size = unit(1.2, "lines"),
     plot.tag = element_text(size = 24, face = "bold")
  )

figure3


#ggsave("../figures/Figure_3.png", plot = figure3, width = 10, height = 15, dpi = 700)
```




## Revised Figure 3 with p-val and % change
```{r, fig.width= 18, fig.height=12}


df_annotate_prot <- df_summary %>%
  left_join(ttest_results_prot, by = c("Mass", "IsoWindow")) %>%
  group_by(Mass, IsoWindow) %>%
  summarise(
    y_pos = max(mean_proteins + sd_proteins, na.rm = TRUE) + 50,
    sig_label = unique(sig_label),
    .groups = "drop"
  )

df_annotate_precur <- df_summary %>%
  left_join(ttest_results_precur, by = c("Mass", "IsoWindow")) %>%
  group_by(Mass, IsoWindow) %>%
  summarise(
    y_pos = max(mean_precursors + sd_precursors, na.rm = TRUE) + 3000,
    sig_label = unique(sig_label),
    .groups = "drop"
  )




protein_plt_sigfig = ggplot(df_summary, aes(x = Mass, y = mean_proteins, color = Instrument)) +
  geom_line(size = 2, alpha = 1) +
  geom_point(size = 5) +
  geom_errorbar(aes(ymin = mean_proteins - sd_proteins,
                    ymax = mean_proteins + sd_proteins),
                width = 50, linewidth = 1.2) +
  geom_text(data = df_annotate_prot,
            aes(x = Mass, y = y_pos, label = sig_label),
            inherit.aes = FALSE,
            size = 6, vjust = 0) +  # Adjust `size` and `vjust` as needed
  scale_color_manual(values = my_colors) +
  facet_wrap(~ IsoWindow) +
  labs(x = "Input HeLa mass (ng)",
       y = "Proteins detected",
       color = "Instrument") +
  scale_y_continuous(
    limits = c(8800, 9900),
    breaks = seq(8900, 9900, by = 500)
  ) +
  xlim(0, 2000)+
  theme_bw() + theme(
    legend.position = "none",
    legend.title = element_blank(),
    panel.grid.major = element_line(linetype = "dashed", color = "gray80"),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5),
    axis.title = element_text(size = 22),
    axis.text = element_text(size = 20),
    strip.text = element_text(size = 20),  
    axis.text.x = element_text(angle = 45, hjust = 1),
  )

precursor_plt_sigfig = ggplot(df_summary, aes(x = Mass, y = mean_precursors, color = Instrument)) +
  geom_line(size = 2, alpha = 1) +
  geom_point(size = 5) +
  geom_errorbar(aes(ymin = mean_precursors - sd_precursors,
                    ymax = mean_precursors + sd_precursors),
                width = 50, linewidth = 1.2) +
  geom_text(data = df_annotate_precur,
            aes(x = Mass, y = y_pos, label = sig_label),
            inherit.aes = FALSE,
            size = 6, vjust = 0) +  # Adjust `size` and `vjust` as needed
  scale_color_manual(values = my_colors) +
  facet_wrap(~ IsoWindow) +
  labs(x = "Input HeLa mass (ng)",
       y = "Precursors detected",
       color = "Instrument") +
  xlim(0, 2000) +
  scale_y_continuous(
    limits = c(157500, 242000),
    breaks = seq(160000, 242000, by = 20000)
  ) +
  theme_bw() + theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    panel.grid.major = element_line(linetype = "dashed", color = "gray80"),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5),
    axis.title = element_text(size = 22),
    axis.text = element_text(size = 20),
    strip.text = element_text(size = 20),  
    axis.text.x = element_text(angle = 45, hjust = 1),
  )


precursor_plt_sigfig




df_percent_change <- df_summary %>%
  select(Instrument, IsoWindow, Mass, mean_proteins, mean_precursors) %>%
  pivot_wider(
    id_cols = c(IsoWindow, Mass),
    names_from = Instrument,
    values_from = c(mean_proteins, mean_precursors)
  ) %>%
  mutate(
    perc_change_prot = 100 * (mean_proteins_Prototype - mean_proteins_Astral) / mean_proteins_Astral,
    perc_change_precur = 100 * (mean_precursors_Prototype - mean_precursors_Astral) / mean_precursors_Astral
  ) %>%
  select(Mass, IsoWindow, perc_change_prot, perc_change_precur) %>%
  pivot_longer(
    cols = c(perc_change_prot, perc_change_precur),
    names_to = "Metric",
    values_to = "PercentChange"
  ) %>%
  mutate(
    Metric = recode(Metric,
      "perc_change_prot" = "Proteins",
      "perc_change_precur" = "Precursors"
    )
  )

df_percent_precur <- df_percent_change %>%
  filter(Metric == "Precursors")

df_percent_prot <- df_percent_change %>%
  filter(Metric == "Proteins")



percent_change_precur_plot <- ggplot(df_percent_precur, aes(x = Mass, y = PercentChange, group = IsoWindow)) +
  geom_line(color = my_colors[2], size = 1.5) +
  geom_point(color = my_colors[2], size = 4) +
  ylim(0, 11)+
  facet_wrap(~ IsoWindow) +
  labs(
    x = "Input HeLa mass (ng)",
    y = "% Change in Precursors\n(Prototype vs Astral)"
  ) +
  theme_bw() +
  theme(
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 20),
    strip.text = element_text(size = 20),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major = element_line(linetype = "dashed", color = "gray80"),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5)
  )

percent_change_prot_plot <- ggplot(df_percent_prot, aes(x = Mass, y = PercentChange)) +
  geom_line(color = my_colors[2], size = 1.5) +
  geom_point(color = my_colors[2], size = 4) +
  ylim(0, 4)+
  facet_wrap(~ IsoWindow) +
  labs(
    x = "Input HeLa mass (ng)",
    y = "% Change in Proteins\n(Prototype vs Astral)"
  ) +
  theme_bw() +
  theme(
    legend.position = "none",
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 20),
    strip.text = element_text(size = 20),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major = element_line(linetype = "dashed", color = "gray80"),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5)
  )

  
figure3_squished <- (precursor_plt_sigfig + protein_plt_sigfig) /
                    (percent_change_precur_plot + percent_change_prot_plot) +
  plot_layout(guides = "collect", heights = c(3, 1)) +  # Increased ratio from 2.2:0.5 to 3:1
  plot_annotation(tag_levels = "A") &
  theme(
    legend.position = "bottom",
    legend.text = element_text(size = 20),
    legend.title = element_blank(),
    legend.key.size = unit(1.2, "lines"),
    plot.tag = element_text(size = 24, face = "bold")
  )


figure3_squished


ggsave("../figures/Figure3.pdf", width =  18, height=12, dpi = 1200)

```


# Figure 4
## Unused: Peptide CV analysis, but still run!
```{r, fig.width= 16, fig.height=8}



my_colors <- c( "#7CA0D4","#DE757B", "#8BA56F","#A48AD3", 
              "#2B8AAE", "#624894","#E995EB", "#BADE86",
               "#073F80", "#40007F", "#80003F", "#0A522A")

clean_df_columns_fn <- function(df) {
  df %>%
    mutate(across(everything(), ~ {
      if (is.numeric(.)) {
        ifelse(is.nan(.), NA, .)
      } else {
        ifelse(. == "#N/A", NA, .)
      }
    }))
}


# Updated function to handle both CV and Mean (Area)
split_columns_to_dfs_cv <- function(df) {
  df_list <- list()

  metadata_cols <- c("Peptide", "Protein", "Precursor")  # Add more if needed
  metadata_df <- df %>% select(any_of(metadata_cols))

  for (colname in names(df)) {
    # Skip metadata columns
    if (colname %in% metadata_cols) next

    matches <- str_match(
      colname,
      "^([A-Za-z]+)_([0-9]+)ng_([0-9a-zA-Z]+)\\.(CV|Mean|StdDev)"
    )

    if (all(is.na(matches))) next

    instrument <- matches[1, 2]
    mass <- matches[1, 3]
    isowindow <- matches[1, 4]
    measure <- matches[1, 5]

    df_list[[colname]] <- tibble(
      id = seq_len(nrow(df)),
      instrument = instrument,
      mass = mass,
      IsoWindow = isowindow,
      measure_type = measure,
      value = as.numeric(df[[colname]])
    )
  }

  # Combine long format
  long_df <- bind_rows(df_list)

  # Join metadata back
  long_df <- long_df %>%
    left_join(
      metadata_df %>%
        mutate(id = seq_len(nrow(metadata_df))),
      by = "id"
    )

  # Pivot to wide format
  wide_df <- long_df %>%
    pivot_wider(names_from = measure_type, values_from = value) %>%
    select(id, Peptide, Protein, Precursor, instrument, mass, IsoWindow, everything())

  return(wide_df)
}

calculate_cv_ratios <- function(df_reformatted) {
  df_reformatted %>%
    select(id, instrument, IsoWindow, CV, mass) %>%
    pivot_wider(names_from = instrument, values_from = CV) %>%
    mutate(Actis_to_Astral_CV_ratio = Actis / Astral)
}


df_cv_200ng = read.csv("../data/hela_isolation_window/CV_data/peptide_CV_200ng.csv")
df_cv_500ng = read.csv("../data/hela_isolation_window/CV_data/peptide_CV_500ng.csv")
df_cv_1000ng = read.csv("../data/hela_isolation_window/CV_data/peptide_CV_1000ng.csv")
df_cv_2000ng = read.csv("../data/hela_isolation_window/CV_data/peptide_CV_2000ng.csv")



df_cv_200ng_clean = clean_df_columns_fn(df_cv_200ng)
df_cv_500ng_clean = clean_df_columns_fn(df_cv_500ng)
df_cv_1000ng_clean = clean_df_columns_fn(df_cv_1000ng)
df_cv_2000ng_clean = clean_df_columns_fn(df_cv_2000ng)


df_cv_200ng_reformat = split_columns_to_dfs_cv(df_cv_200ng_clean)
df_cv_500ng_reformat = split_columns_to_dfs_cv(df_cv_500ng_clean)
df_cv_1000ng_reformat = split_columns_to_dfs_cv(df_cv_1000ng_clean)
df_cv_2000ng_reformat = split_columns_to_dfs_cv(df_cv_2000ng_clean)



df_cv_combined = bind_rows(df_cv_200ng_reformat,
                           df_cv_500ng_reformat,
                           df_cv_1000ng_reformat,
                           df_cv_2000ng_reformat)


df_cv_combined1 = df_cv_combined

df_cv_combined1$mass <- paste0(as.character(df_cv_combined1$mass), "ng")
df_cv_combined1$mass <- factor(df_cv_combined1$mass, levels = c("2000ng", "1000ng", "500ng", "200ng"))


df_cv_combined1$IsoWindow <- ifelse(grepl("2mz", df_cv_combined1$IsoWindow, ignore.case = TRUE), "2 Th with 4 ms IT",
                     ifelse(grepl("3mz", df_cv_combined1$IsoWindow, ignore.case = TRUE), "3 Th with 6 ms IT",
                     ifelse(grepl("4mz", df_cv_combined1$IsoWindow, ignore.case = TRUE), "4 Th with 8 ms IT",NA)))


df_cv_combined_actis <- df_cv_combined1 %>%
  filter(instrument == "Actis")

df_cv_combined_astral <- df_cv_combined1 %>%
  filter(instrument == "Astral")


# HISTOGRAMS
# Calculate median CV for each mass and IsoWindow group
median_data_actis <- df_cv_combined_actis %>%
  group_by(mass, IsoWindow) %>%
  summarise(median_CV = median(CV * 100, na.rm = TRUE)) %>%
  mutate(label = sprintf("Median: %.1f%%", median_CV))


actis_cv = ggplot(df_cv_combined_actis, aes(x = CV * 100, fill = mass)) +
  geom_histogram(position = "identity", alpha = 0.7, bins = 200) +
  
    geom_vline(
    data = median_data_actis,
    aes(xintercept = median_CV),
    linetype = "dashed",
    color = "black",
    linewidth = 1
  ) +
  
  geom_text(
    data = median_data_actis,
    aes(x = median_CV, y = Inf, label = label),
    color = "black",
    vjust = 1.5,        # Vertical adjustment to position below top
    hjust = -0.1,       # Horizontal adjustment to align with line
    size = 5
  ) +
  facet_grid(mass ~ IsoWindow) +
  labs(x = "% Coefficient of variation",
       y = " ",
       fill = "Instrument",
       title = "Prototype") +
  #geom_vline(xintercept = 20, linetype = "dashed", linewidth = 1, color = "grey") +
  coord_cartesian(xlim = c(0, 75)) +
  ylim(0, 14000)+

  scale_fill_manual(values = my_colors) +
  theme_bw() +   theme(
    legend.position = "none",
  text = element_text(size = 18),  # Global text size
  axis.title = element_text(size = 20),  # Axis titles
  axis.text = element_text(size = 17),   # Axis tick labels
  legend.title = element_text(size = 18),
  legend.text = element_text(size = 17),
  axis.text.x = element_text(angle = 45, hjust = 1),
  strip.text = element_text(size = 18)   # Facet labels
)



# Calculate median CV for each mass and IsoWindow group
median_data_astral <- df_cv_combined_astral %>%
  group_by(mass, IsoWindow) %>%
  summarise(median_CV = median(CV * 100, na.rm = TRUE)) %>%
  mutate(label = sprintf("Median: %.1f%%", median_CV))

astral_cv = ggplot(df_cv_combined_astral, aes(x = CV * 100, fill = mass)) +
  geom_histogram(position = "identity", alpha = 0.7, bins = 200) +
  facet_grid(mass ~ IsoWindow) +
  geom_vline(
    data = median_data_astral,
    aes(xintercept = median_CV),
    linetype = "dashed",
    color = "black",
    linewidth = 1
  ) +
  
  geom_text(
    data = median_data_astral,
    aes(x = median_CV, y = Inf, label = label),
    color = "black",
    vjust = 1.5,        # Vertical adjustment to position below top
    hjust = -0.1,       # Horizontal adjustment to align with line
    size = 5
  ) +
  
  labs(x = "% Coefficient of variation",
       y = "Count",
       fill = "Instrument",
       title = "Astral") +
  #geom_vline(xintercept = 20, linetype = "dashed", linewidth = 1, color = "grey") +
  coord_cartesian(xlim = c(0, 75)) +
  ylim(0, 14000)+
  scale_fill_manual(values = my_colors) +
  theme_bw() +   theme(
    legend.position = "none",
  text = element_text(size = 18),  # Global text size
  axis.title = element_text(size = 20),  # Axis titles
  axis.text = element_text(size = 17),   # Axis tick labels
  legend.title = element_text(size = 18),
  legend.text = element_text(size = 17),
  axis.text.x = element_text(angle = 45, hjust = 1),
  strip.text = element_text(size = 18)   # Facet labels
)




#astral_cv + actis_cv

unused_figure4 = (astral_cv + actis_cv) + plot_annotation(tag_levels = "A") & 
  theme(plot.tag = element_text(size = 20, face = "bold"))

unused_figure4

#ggsave("Unused_CV_Figure_4_plot.png", plot = unused_figure4, width = 16, height = 8, dpi = 700)


```



## Fig4A: Peptide CV code
```{r, fig.width=12, fig.height=7}

library(ggplot2)
library(plyr)  # Needed for arrange()



df_cv_combined2 = df_cv_combined

df_cv_combined2$instrument <- ifelse(grepl("Astral", df_cv_combined2$instrument, ignore.case = TRUE), "Astral",
                     ifelse(grepl("Actis", df_cv_combined2$instrument, ignore.case = TRUE), "Prototype",NA))


df_cv_combined2$instrument <- factor(df_cv_combined2$instrument, levels = c("Astral","Prototype"))
df_cv_combined2$mass <- factor(df_cv_combined2$mass, levels = c("2000", "1000", "500", "200"))

df_cv_combined2$IsoWindow <- ifelse(grepl("2mz", df_cv_combined$IsoWindow, ignore.case = TRUE), "2 Th with 4 ms IT",
                     ifelse(grepl("3mz", df_cv_combined$IsoWindow, ignore.case = TRUE), "3 Th with 6 ms IT",
                     ifelse(grepl("4mz", df_cv_combined$IsoWindow, ignore.case = TRUE), "4 Th with 8 ms IT",NA)))


figure4A = ggplot(df_cv_combined2, aes(x = factor(mass), y = CV * 100, fill = instrument)) +
  geom_split_violin(alpha = 0.7, trim = TRUE, draw_quantiles = 0.5) +
  coord_cartesian(ylim = c(0, 50)) +
  facet_wrap(~ IsoWindow, ncol = 3) +
  theme_bw() +
  labs(x = "Input HeLa mass (ng)", y = "Coefficient of variation (%)", title = "Peptide") +
  scale_fill_manual(values = c("Astral" = "#4393C3", "Prototype" = "#D6604D")) + 
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    panel.grid.major = element_line(linetype = "dashed", color = "gray80"),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5),
    axis.title = element_text(size = 22),
    axis.text = element_text(size = 20),
      strip.text = element_text(size = 20),  
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.text = element_text(size = 18),      # <-- Increase text size
    #legend.title = element_text(size = 16),     # <-- (optional) title size
    legend.key.size = unit(1.2, "lines"),
  ) +  ggtitle("Peptide") + 
  theme(plot.title = element_text(size = 22, hjust = 0))


figure4A


```




## Fig4B. Protein CV code

I did not use skyline to calculate the CVs, so we will need to do it in the code here. I used the MJM protein areas output pivot table in Skyline document to generate the protein area data.

```{r, fig.width=12, fig.height=7, message=FALSE, warning=FALSE}
compute_protein_cvs <- function(file_path, input_ng = "200ng") {
  library(readr)
  library(dplyr)
  library(tidyr)
  library(stringr)
  
  # Read file (no headers in original format)
  df <- read_csv(file_path, col_names = FALSE)
  
  # Extract metadata and data
  metadata <- df[1:3, ]
  data <- df[-c(1:3), ]
  
  # Set column names using first row of metadata
  colnames(data) <- as.character(metadata[1, ])
  
  # Convert relevant columns to numeric
  data_numeric <- data
  data_numeric[, 4:21] <- lapply(data_numeric[, 4:21], function(x) as.numeric(as.character(x)))
  
  # Define column groupings for CV calculation
  col_groups <- list(
    c(4, 5, 6),   # Actis_2mz
    c(7, 8, 9),   # Actis_3mz
    c(10, 11, 12), # Actis_4mz
    c(13, 14, 15), # Astral_2mz
    c(16, 17, 18), # Astral_3mz
    c(19, 20, 21)  # Astral_4mz
  )
  
  # Create new column names in format: Instrument_inputng_mass_CV
  labels <- c("Actis_2mz", "Actis_3mz", "Actis_4mz", 
              "Astral_2mz", "Astral_3mz", "Astral_4mz")
  new_col_names <- paste0(
    str_extract(labels, "^[A-Za-z]+"), "_",  # Instrument
    input_ng, "_",                           # Input amount
    str_extract(labels, "\\d+mz"),           # Mass window
    "_CV"                                    # CV suffix
  )
  
  # Compute CVs row-wise for each group and add as new columns
  for (i in seq_along(col_groups)) {
    group <- data_numeric[, col_groups[[i]]]
    means <- rowMeans(group, na.rm = TRUE)
    sds <- apply(group, 1, sd, na.rm = TRUE)
    data_numeric[[new_col_names[i]]] <- sds / means
  }
  
  # Keep only the first three identifier columns and the new CV columns
  data_numeric <- data_numeric %>%
    select(1:3, all_of(new_col_names))
  
  # Pivot to long format and extract metadata
 long_data <- data_numeric %>%
  pivot_longer(
    cols = contains("_CV"),
    names_to = "measurement",
    values_to = "CV"
  ) %>%
  mutate(
    instrument = str_extract(measurement, "^[A-Za-z]+"),
    mass = str_extract(measurement, "(?<=_)[0-9]+ng"),  # Extract between _ and ng
    IsoWindow = str_extract(measurement, "\\d+mz"),     # Extract digits followed by mz
  ) %>%
  select(-measurement) %>%  # Remove temporary column
  rename(
    id = 1,
    protein_id = 2,
    protein_name = 3
  )
  
  return(long_data)
}


clean_mass <- function(df) {
  df$mass <- gsub("ng$", "", df$mass)
  df$mass <- factor(df$mass, levels = c("200", "500", "1000", "2000"))
  df$mass <- as.numeric(as.character(df$mass))
  return(df)
}



df_200ng_prot_CV = compute_protein_cvs("../data/hela_isolation_window/CV_data/protein_CV_200ng_uncalculated.csv", input_ng = "200ng")
df_500ng_prot_CV = compute_protein_cvs("../data/hela_isolation_window/CV_data/protein_CV_500ng_uncalculated.csv", input_ng = "500ng")
df_1000ng_prot_CV = compute_protein_cvs("../data/hela_isolation_window/CV_data/protein_CV_1000ng_uncalculated.csv", input_ng = "1000ng")
df_2000ng_prot_CV = compute_protein_cvs("../data/hela_isolation_window/CV_data/protein_CV_2000ng_uncalculated.csv", input_ng = "2000ng")



prot_cv_combined = bind_rows(df_200ng_prot_CV, df_500ng_prot_CV, df_1000ng_prot_CV, df_2000ng_prot_CV)


prot_cv_combined$instrument <- ifelse(grepl("Astral", prot_cv_combined$instrument, ignore.case = TRUE), "Astral",
                     ifelse(grepl("Actis", prot_cv_combined$instrument, ignore.case = TRUE), "Prototype",NA))


prot_cv_combined1 = prot_cv_combined

prot_cv_combined1 = clean_mass(prot_cv_combined1)

prot_cv_combined1$instrument <- factor(prot_cv_combined1$instrument, levels = c("Astral","Prototype"))
prot_cv_combined1$mass <- factor(prot_cv_combined1$mass, levels = c("2000", "1000", "500", "200"))

prot_cv_combined1$IsoWindow <- ifelse(grepl("2mz", prot_cv_combined$IsoWindow, ignore.case = TRUE), "2 Th with 4 ms IT",
                     ifelse(grepl("3mz", prot_cv_combined$IsoWindow, ignore.case = TRUE), "3 Th with 6 ms IT",
                     ifelse(grepl("4mz", prot_cv_combined$IsoWindow, ignore.case = TRUE), "4 Th with 8 ms IT",NA)))


figure4B = ggplot(prot_cv_combined1, aes(x = factor(mass), y = CV * 100, fill = instrument)) +
  geom_split_violin(alpha = 0.7, trim = TRUE, draw_quantiles = 0.5) +
  coord_cartesian(ylim = c(0, 20)) +
  facet_wrap(~ IsoWindow, ncol = 3) +
  theme_bw() +
  labs(x = "Input HeLa mass (ng)", y = "Coefficient of variation (%)", title = "Protein") +
  scale_fill_manual(values = c("Astral" = "#4393C3", "Prototype" = "#D6604D")) + 
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    panel.grid.major = element_line(linetype = "dashed", color = "gray80"),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5),
    axis.title = element_text(size = 22),
    axis.text = element_text(size = 20),
      strip.text = element_text(size = 20),  
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.text = element_text(size = 18),      # <-- Increase text size
    #legend.title = element_text(size = 16),     # <-- (optional) title size
    legend.key.size = unit(1.2, "lines"),
  ) + ggtitle("Protein") + 
  theme(plot.title = element_text(size = 22, hjust = 0))


figure4B

```

## Full plot Fig4
```{r, fig.width=12, fig.height=13, message=FALSE, warning=FALSE}


figure4 <- (figure4A / figure4B) + 
  plot_layout(ncol = 1, guides = "collect") + 
  plot_annotation(tag_levels = "A") & 
  theme(
    legend.position = "bottom",
    legend.text = element_text(size = 20),      # <-- Increase text size
    legend.title = element_blank(),
    legend.key.size = unit(1.2, "lines"),
     plot.tag = element_text(size = 24, face = "bold")
  )


figure4

ggsave("../figures/Figure_4.pdf", plot = figure4, width = 12, height = 13, dpi = 700)



```


# Figure 5
## Ion analysis processing
```{r}

split_columns_to_lc_ion_dfs <- function(df) {
  df_list <- list()

  # Store identifying metadata
  id_cols <- df %>%
    dplyr::select(Protein, Peptide, Precursor) %>%
    dplyr::mutate(id = dplyr::row_number())

  for (colname in names(df)) {
    matches <- str_match(
      colname,
      "^([A-Za-z]+)_([0-9]+)ng_([0-9a-zA-Z]+)\\.(CV|Mean|StdDev)\\."
    )

    # If match failed, skip this column
    if (all(is.na(matches))) next

    instrument <- matches[1, 2]
    mass <- matches[1, 3]
    isowindow <- matches[1, 4]
    measure <- matches[1, 5]

    # Only keep "Mean" columns
    if (measure != "Mean") next

    df_list[[colname]] <- tibble(
      id = seq_len(nrow(df)),
      instrument = instrument,
      mass = mass,
      IsoWindow = isowindow,
      Mean = na_if(as.numeric(df[[colname]]), NaN)
    )
  }

  # Combine all long-format Mean columns
  df_combined <- bind_rows(df_list)

  # Join with identifying metadata
  df_combined <- left_join(df_combined, id_cols, by = "id") %>%
    select(Protein, Peptide, Precursor, everything(), -id)

  return(df_combined)
}


clean_df_columns_fn <- function(df) {
  df %>%
    mutate(across(everything(), ~ {
      if (is.numeric(.)) {
        ifelse(is.nan(.), NA, .)
      } else {
        ifelse(. == "#N/A", NA, .)
      }
    }))
}


breaks <- 10^(-10:10)
minor_breaks <- rep(1:9, 21)*(10^rep(-10:10, each=9))
x_limits <- c(5, 10^8)  # Set limits from 1 to 10^5 for log10 scale


df_lc_ions_200ng = read.csv("../data/hela_isolation_window/LC_peak_peptide_ions/200ng_lc_ions_pivot_CH.csv")
df_lc_ions_500ng = read.csv("../data/hela_isolation_window/LC_peak_peptide_ions/500ng_lc_ions_pivot_CH.csv")
df_lc_ions_1000ng = read.csv("../data/hela_isolation_window/LC_peak_peptide_ions/1000ng_lc_ions_pivot_CH.csv")
df_lc_ions_2000ng = read.csv("../data/hela_isolation_window/LC_peak_peptide_ions/2000ng_lc_ions_pivot_CH.csv")


df_lc_ions_200ng_cleaned = clean_df_columns_fn(df_lc_ions_200ng)
df_lc_ions_500ng_cleaned = clean_df_columns_fn(df_lc_ions_500ng)
df_lc_ions_1000ng_cleaned = clean_df_columns_fn(df_lc_ions_1000ng)
df_lc_ions_2000ng_cleaned = clean_df_columns_fn(df_lc_ions_2000ng)


df_lc_ions_200ng_format = split_columns_to_lc_ion_dfs(df_lc_ions_200ng_cleaned)
df_lc_ions_500ng_format = split_columns_to_lc_ion_dfs(df_lc_ions_500ng_cleaned)
df_lc_ions_1000ng_format = split_columns_to_lc_ion_dfs(df_lc_ions_1000ng_cleaned)
df_lc_ions_2000ng_format = split_columns_to_lc_ion_dfs(df_lc_ions_2000ng_cleaned)


df_lc_ions_combined = bind_rows(df_lc_ions_200ng_format,
                                df_lc_ions_500ng_format,
                                df_lc_ions_1000ng_format,
                                df_lc_ions_2000ng_format)



df_lc_ions_combined1 = df_lc_ions_combined

df_lc_ions_combined1$mass <- factor(df_lc_ions_combined1$mass, levels = c("2000", "1000", "500", "200"))


df_lc_ions_combined1 <- df_lc_ions_combined1 %>%
  mutate(IsoWindow = recode(IsoWindow,
    "2mz" = "2 Th with 4 ms IT",
    "3mz" = "3 Th with 6 ms IT",
    "4mz" = "4 Th with 8 ms IT"
  ))


df_lc_ions_combined1$instrument <- ifelse(grepl("Astral", df_lc_ions_combined$instrument, ignore.case = TRUE), "Astral",
                     ifelse(grepl("Actis", df_lc_ions_combined$instrument, ignore.case = TRUE), "Prototype",NA))


df_lc_ions_combined_astral = df_lc_ions_combined1 %>%
  filter(instrument == "Astral")

df_lc_ions_combined_actis = df_lc_ions_combined1 %>%
  filter(instrument == "Prototype")

```


## BioRxiv submission plots
### Old Fig4AB: Mode LC ions Full Distribution
```{r, fig.width= 16, fig.height=8}

my_colors <- c( "#7CA0D4","#DE757B", "#8BA56F","#A48AD3", 
              "#2B8AAE", "#624894","#E995EB", "#BADE86",
               "#073F80", "#40007F", "#80003F", "#0A522A")

df_lc_ions_combined_astral1 = df_lc_ions_combined_astral
df_lc_ions_combined_actis1 = df_lc_ions_combined_actis



df_lc_ions_combined_astral1$mass <- paste0(as.character(df_lc_ions_combined_astral1$mass), "ng")
df_lc_ions_combined_astral1$mass <- factor(df_lc_ions_combined_astral1$mass, levels = c("2000ng", "1000ng", "500ng", "200ng"))

df_lc_ions_combined_actis1$mass <- paste0(as.character(df_lc_ions_combined_actis1$mass), "ng")
df_lc_ions_combined_actis1$mass <- factor(df_lc_ions_combined_actis1$mass, levels = c("2000ng", "1000ng", "500ng", "200ng"))

# Build plots
p_astral <- ggplot(df_lc_ions_combined_astral1, aes(x = Mean / 1.53, fill = mass)) +
  geom_density(alpha = 0.35) +
  facet_grid(mass ~ IsoWindow) +
  scale_x_log10(
    breaks = trans_breaks("log10", function(x) 10^x),
    labels = trans_format("log10", math_format(10^.x))
  ) +
  theme_bw()


p_actis <- ggplot(df_lc_ions_combined_actis1, aes(x = Mean / 1.31, fill = mass)) +
  geom_density(alpha = 0.55) +
  facet_grid(mass ~ IsoWindow) +
  scale_x_log10(
    breaks = trans_breaks("log10", function(x) 10^x),
    labels = trans_format("log10", math_format(10^.x))
  ) +
  theme_bw()

# Extract data for Astral
pb_astral <- ggplot_build(p_astral)
plot_data_astral <- pb_astral$data[[1]]
panel_layout_astral <- pb_astral$layout$layout %>% select(PANEL, mass, IsoWindow)

plot_data_astral <- left_join(plot_data_astral, panel_layout_astral, by = "PANEL")

density_modes_astral <- plot_data_astral %>%
  group_by(PANEL) %>%
  slice_max(y, n = 1, with_ties = FALSE) %>%
  mutate(fixed_x = round(10^x),
         label = paste0("Mode: ", fixed_x))

# Extract data for Actis
pb_actis <- ggplot_build(p_actis)
plot_data_actis <- pb_actis$data[[1]]
panel_layout_actis <- pb_actis$layout$layout %>% select(PANEL, mass, IsoWindow)

plot_data_actis <- left_join(plot_data_actis, panel_layout_actis, by = "PANEL")

density_modes_actis <- plot_data_actis %>%
  group_by(PANEL) %>%
  slice_max(y, n = 1, with_ties = FALSE) %>%
  mutate(fixed_x = round(10^x),
         label = paste0("Mode: ", fixed_x))

# Final Astral plot
lc_ions_astral_plot <- p_astral +
  geom_vline(
    data = density_modes_astral,
    aes(xintercept = 10^x),
    color = "black",
    linetype = "dotted",
    linewidth = 1
  ) +
  
  geom_text(
    data = density_modes_astral,
    aes(
      x = Inf,
      y = Inf,
      label = label
    ),
    vjust = 1.5,
    hjust = 1.1,
    size = 5,
    fontface = "bold",     # <-- Bold text
    inherit.aes = FALSE
  ) +
  labs(
    x = "LC peak peptide ions",
    y = "Density",
    title = "Astral"
  ) +
  coord_cartesian(ylim = c(0, 0.89)) +

  scale_fill_manual(values = my_colors) +
  theme_bw() +
  theme(
    text = element_text(size = 16),
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 15),
    legend.title = element_text(size = 16),
    legend.text = element_text(size = 15),
    strip.text = element_text(size = 16),
    legend.position = "none"
  )

# Final Actis plot
lc_ions_actis_plot <- p_actis +
  geom_vline(
    data = density_modes_actis,
    aes(xintercept = 10^x),
    color = "black",
    linetype = "dotted",
    linewidth = 1
  ) +
  geom_text(
    data = density_modes_actis,
    aes(
      x = Inf,
      y = Inf,
      label = label
    ),
    vjust = 1.5,
    hjust = 1.1,
    size = 5,
    fontface = "bold",
    inherit.aes = FALSE
  ) +
  labs(
    x = "LC peak peptide ions",
    y = "Density",
    title = "Prototype"
  ) +
  coord_cartesian(ylim = c(0, 0.89)) +

  scale_fill_manual(values = my_colors) +
  theme_bw() +
  theme(
    text = element_text(size = 16),
    axis.title = element_text(size = 18),
    axis.text = element_text(size = 15),
    legend.title = element_text(size = 16),
    legend.text = element_text(size = 15),
    strip.text = element_text(size = 16),
    legend.position = "none"
  )

# Combine and display
(lc_ions_astral_plot + lc_ions_actis_plot)


figure4_full_LC_ions = (lc_ions_astral_plot + lc_ions_actis_plot) + plot_annotation(tag_levels = "A") & 
  theme(plot.tag = element_text(size = 20, face = "bold"))




```




### Old Fig5C 
```{r, fig.height=5, fig.width=8}



density_modes_astral$Instrument <- "Astral"
density_modes_actis$Instrument  <- "Prototype"
density_modes_combined <- bind_rows(density_modes_astral, density_modes_actis)

density_modes_combined$mass <- sub("ng$", "", density_modes_combined$mass)


# Plot faceted by IsoWindow
facet_lc_ions_by_isowindow <- ggplot(density_modes_combined, aes(x = as.numeric(mass), y = fixed_x, color = Instrument)) +
  geom_line(size = 2, alpha = 1) +
  geom_point(size = 5) +
  labs(
    x = "Input HeLa mass (ng)",
    y = "Mode LC peak ions",
    color = "Instrument"
  ) +
  xlim(0, 2000)+
  ylim(0, 400) +
  scale_color_manual(values = c( "#7CA0D4","#DE757B")) +
  facet_wrap(~ IsoWindow) +  # Facet by IsoWindow instead of Instrument
  theme_bw() +
  theme(
    text = element_text(size = 14),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 13),
    legend.text = element_text(size = 13),
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 14),
    legend.position = "bottom",
    legend.title = element_blank()
  )

# Display the plot
facet_lc_ions_by_isowindow


```


### Old Fig5D: Percentage ions improvement
```{r}
# Combine data for matching conditions
improvement_df <- density_modes_astral %>%
  select(mass, IsoWindow, Astral_mode = fixed_x) %>%
  inner_join(
    density_modes_actis %>% select(mass, IsoWindow, Actis_mode = fixed_x),
    by = c("mass", "IsoWindow")
  ) %>%
  mutate(
    pct_increase = 100 * (Actis_mode - Astral_mode) / Astral_mode,
    label = paste0(round(pct_increase), "%")
  )

improvement_df$mass <- sub("ng$", "", improvement_df$mass)


improvement_df$mass <- factor(improvement_df$mass, levels = c("200", "500", "1000", "2000"))




pct_improve_plot = ggplot(improvement_df, aes(x = factor(mass), y = pct_increase, fill = IsoWindow)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.7, alpha = 0.65) +
  geom_text(aes(label = label), position = position_dodge(width = 0.8), vjust = -0.5, size = 4) +
  scale_fill_manual(values = c("#7CA0D4", "#DE757B", "#8BA56F")) +
 annotate(
    "text",
    x = 4.2,                             # Slightly beyond the last bar
    y = 58,                              # Near the top of the y-axis
    label = paste0("Median: ", round(median(improvement_df$pct_increase), 2), "%"),
    size = 5,
    fontface = "bold",
    hjust = 1
  )+
  labs(
    title = "",
    x = "Input HeLa mass (ng)",
    y = "% Increase in Mode LC peak ions \n(Prototype vs Astral)",
    fill = "Isolation Window"
  ) +
  ylim(0, 60)+
  theme_bw() +
  theme(
    text = element_text(size = 14),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 13),
    #legend.title = element_text(size = 14),
    legend.text = element_text(size = 13),
    strip.text = element_text(size = 14),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.title=element_blank(),
    legend.position = "bottom")  


pct_improve_plot


```



### Old Full plot Fig5: 
```{r, fig.width=16, fig.height=14}
figure5_mode_LC_A = (lc_ions_astral_plot + lc_ions_actis_plot)




figure5_mode_LC_B = facet_lc_ions_by_isowindow


figure5_mode_LC_C = pct_improve_plot

figure5_mode_LC_BC = (figure5_mode_LC_B + figure5_mode_LC_C)



figure5_mode <- (figure5_mode_LC_A / figure5_mode_LC_BC) + 
  plot_layout(ncol = 1, heights = c(1.4, 0.8))+
  plot_annotation(tag_levels = "A") & 
  theme(
    #legend.text = element_text(size = 20),  # Controls legend text
    legend.key.size = unit(1.2, "lines"),
    plot.tag = element_text(size = 24, face = "bold")  # Adjust annotation tag size here
  )

figure5_mode


#ggsave("../figures/Figure_5.png", plot = figure5_mode, width = 16, height = 14, dpi = 1000)


```













## Fig4A: Reviewer edited - merged plot
```{r}


split_columns_to_lc_ion_dfs <- function(df) {
  df_list <- list()

  # Store identifying metadata
  id_cols <- df %>%
    dplyr::select(Protein, Peptide, Precursor) %>%
    dplyr::mutate(id = dplyr::row_number())

  for (colname in names(df)) {
    matches <- str_match(
      colname,
      "^([A-Za-z]+)_([0-9]+)ng_([0-9a-zA-Z]+)\\.(CV|Mean|StdDev)\\."
    )

    # If match failed, skip this column
    if (all(is.na(matches))) next

    instrument <- matches[1, 2]
    mass <- matches[1, 3]
    isowindow <- matches[1, 4]
    measure <- matches[1, 5]

    # Only keep "Mean" columns
    if (measure != "Mean") next

    df_list[[colname]] <- tibble(
      id = seq_len(nrow(df)),
      instrument = instrument,
      mass = mass,
      IsoWindow = isowindow,
      Mean = na_if(as.numeric(df[[colname]]), NaN)
    )
  }

  # Combine all long-format Mean columns
  df_combined <- bind_rows(df_list)

  # Join with identifying metadata
  df_combined <- left_join(df_combined, id_cols, by = "id") %>%
    select(Protein, Peptide, Precursor, everything(), -id)

  return(df_combined)
}


clean_df_columns_fn <- function(df) {
  df %>%
    mutate(across(everything(), ~ {
      if (is.numeric(.)) {
        ifelse(is.nan(.), NA, .)
      } else {
        ifelse(. == "#N/A", NA, .)
      }
    }))
}


breaks <- 10^(-10:10)
minor_breaks <- rep(1:9, 21)*(10^rep(-10:10, each=9))
x_limits <- c(5, 10^8)  # Set limits from 1 to 10^5 for log10 scale

df_lc_ions_200ng = read.csv("../data/hela_isolation_window/LC_peak_peptide_ions/200ng_lc_ions_pivot_CH.csv")
df_lc_ions_500ng = read.csv("../data/hela_isolation_window/LC_peak_peptide_ions/500ng_lc_ions_pivot_CH.csv")
df_lc_ions_1000ng = read.csv("../data/hela_isolation_window/LC_peak_peptide_ions/1000ng_lc_ions_pivot_CH.csv")
df_lc_ions_2000ng = read.csv("../data/hela_isolation_window/LC_peak_peptide_ions/2000ng_lc_ions_pivot_CH.csv")


df_lc_ions_200ng_cleaned = clean_df_columns_fn(df_lc_ions_200ng)
df_lc_ions_500ng_cleaned = clean_df_columns_fn(df_lc_ions_500ng)
df_lc_ions_1000ng_cleaned = clean_df_columns_fn(df_lc_ions_1000ng)
df_lc_ions_2000ng_cleaned = clean_df_columns_fn(df_lc_ions_2000ng)


df_lc_ions_200ng_format = split_columns_to_lc_ion_dfs(df_lc_ions_200ng_cleaned)
df_lc_ions_500ng_format = split_columns_to_lc_ion_dfs(df_lc_ions_500ng_cleaned)
df_lc_ions_1000ng_format = split_columns_to_lc_ion_dfs(df_lc_ions_1000ng_cleaned)
df_lc_ions_2000ng_format = split_columns_to_lc_ion_dfs(df_lc_ions_2000ng_cleaned)


df_lc_ions_combined = bind_rows(df_lc_ions_200ng_format,
                                df_lc_ions_500ng_format,
                                df_lc_ions_1000ng_format,
                                df_lc_ions_2000ng_format)



df_lc_ions_combined1 = df_lc_ions_combined


df_lc_ions_combined1$mass <- paste0(as.character(df_lc_ions_combined1$mass), "ng")
df_lc_ions_combined1$mass <- factor(df_lc_ions_combined1$mass, levels = c("2000ng", "1000ng", "500ng", "200ng"))


df_lc_ions_combined1 <- df_lc_ions_combined1 %>%
  mutate(IsoWindow = recode(IsoWindow,
    "2mz" = "2 Th with 4 ms IT",
    "3mz" = "3 Th with 6 ms IT",
    "4mz" = "4 Th with 8 ms IT"
  ))


df_lc_ions_combined1$instrument <- ifelse(grepl("Astral", df_lc_ions_combined$instrument, ignore.case = TRUE), "Astral",
                     ifelse(grepl("Actis", df_lc_ions_combined$instrument, ignore.case = TRUE), "Prototype",NA))


df_lc_ions_combined_astral = df_lc_ions_combined1 %>%
  filter(instrument == "Astral")

df_lc_ions_combined_actis = df_lc_ions_combined1 %>%
  filter(instrument == "Prototype")

my_colors <- c( "#7CA0D4","#DE757B", "#8BA56F","#A48AD3", 
              "#2B8AAE", "#624894","#E995EB", "#BADE86",
               "#073F80", "#40007F", "#80003F", "#0A522A")

df_lc_ions_combined_astral1 = df_lc_ions_combined_astral
df_lc_ions_combined_actis1 = df_lc_ions_combined_actis




# Combine both dataframes and keep track of instrument
df_overlay <- bind_rows(
  df_lc_ions_combined_astral1 %>% mutate(instrument = "Astral"),
  df_lc_ions_combined_actis1 %>% mutate(instrument = "Prototype")
)

# Plot overlayed density curves
p_overlay = ggplot(df_overlay, aes(x = Mean / ifelse(instrument == "Astral", 1.53, 1.31),
                                               color = instrument, fill = instrument)) +
  geom_density(alpha = 0.4) +
  facet_grid(mass ~ IsoWindow) +
  scale_x_log10(
    breaks = trans_breaks("log10", function(x) 10^x),
    labels = trans_format("log10", math_format(10^.x))
  ) +
  scale_color_manual(values = c("Astral" = "#7CA0D4", "Prototype" = "#DE757B")) +
  scale_fill_manual(values = c("Astral" = "#7CA0D4", "Prototype" = "#DE757B")) +
  labs(
    x = "LC peak peptide ions",
    y = "Density",
  ) +
  coord_cartesian(ylim = c(0, 0.89)) +
  theme_bw() +
  theme(
    text = element_text(size = 16),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
    #legend.title = element_text(size = 14),
    legend.text = element_text(size = 16),
    strip.text = element_text(size = 14),
    legend.title=element_blank(),
    legend.position = "top")+ guides(color = "none") +
  guides(
    color = "none",
    fill = guide_legend(override.aes = list(alpha = 1))  # <— solid legend color
  )



# Use ggplot_build to get density data
pb_overlay <- ggplot_build(p_overlay)
plot_data_overlay <- pb_overlay$data[[1]]  # Density data

# Map PANEL info to mass and IsoWindow
panel_layout_overlay <- pb_overlay$layout$layout %>% select(PANEL, mass, IsoWindow)
plot_data_overlay <- left_join(plot_data_overlay, panel_layout_overlay, by = "PANEL")

# Map instrument based on color (must match scale_color_manual!)
plot_data_overlay$instrument <- ifelse(plot_data_overlay$group %% 2 == 1, "Astral", "Prototype")

# Find mode (max y) per panel & instrument
density_modes_overlay <- plot_data_overlay %>%
  group_by(PANEL, instrument) %>%
  slice_max(order_by = y, n = 1, with_ties = FALSE) %>%
  mutate(x_val = 10^x,
         label = paste0("Mode: ", round(x_val)))

# Compute custom label positions next to mode lines
density_modes_overlay_labels <- density_modes_overlay %>%
  mutate(
    label_x = case_when(
      instrument == "Astral" ~ x_val * 0.7,       # Slightly left
      instrument == "Prototype" ~ x_val * 1.3     # Slightly right
    ),
    label_y = y * 1.1,  # Slightly below the peak
    hjust_val = case_when(
      instrument == "Astral" ~ 1,     # Right-aligned to appear left of line
      instrument == "Prototype" ~ 0   # Left-aligned to appear right of line
    )
  )
Figure5A <- p_overlay +
  geom_vline(
    data = density_modes_overlay,
    aes(xintercept = x_val, color = instrument),
    linetype = "dashed",
    linewidth = 0.8,
    inherit.aes = FALSE
  ) +
  geom_text(
    data = density_modes_overlay_labels,
    aes(
      x = label_x,
      y = label_y,
      label = label,
      color = instrument,
      hjust = hjust_val
    ),
    size = 5,
    fontface = "bold",
    inherit.aes = FALSE
  ) +  theme_bw() +
  theme(
    text = element_text(size = 16),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
    #legend.title = element_text(size = 14),
    legend.text = element_text(size = 16),
    strip.text = element_text(size = 18),
    legend.title=element_blank(),
    legend.position = "top")  



Figure5A



```


## Figure 5B: Reviewer edited Line plot
```{r}




# Clean the ion count column
clean_lc_data <- function(df) {
  df %>%
    mutate(
      LC.Ion.Count = ifelse(LC.Peak.Analyte.Ion.Count.Fragment == "#N/A", 
                           NA, 
                           as.numeric(LC.Peak.Analyte.Ion.Count.Fragment))
    ) %>%
    select(Replicate.Name, Protein.Name, Peptide.Sequence, Precursor.Mz, LC.Ion.Count)
}

# REMEMBER TO DECOMPRESS THE FILES BEFORE RUNNING
df_lc_ions_200ng_long = read.csv("../data/hela_isolation_window/LC_peak_peptide_ions/LC_ion_long_data/LC_ion_long_200ng.csv")
df_lc_ions_500ng_long = read.csv("../data/hela_isolation_window/LC_peak_peptide_ions/LC_ion_long_data/LC_ion_long_500ng.csv")
df_lc_ions_1000ng_long = read.csv("../data/hela_isolation_window/LC_peak_peptide_ions/LC_ion_long_data/LC_ion_long_1000ng.csv")
df_lc_ions_2000ng_long = read.csv("../data/hela_isolation_window/LC_peak_peptide_ions/LC_ion_long_data/LC_ion_long_2000ng.csv")


df_200ng_clean_long <- clean_lc_data(df_lc_ions_200ng_long)
df_500ng_clean_long <- clean_lc_data(df_lc_ions_500ng_long)
df_1000ng_clean_long <- clean_lc_data(df_lc_ions_1000ng_long)
df_2000ng_clean_long <- clean_lc_data(df_lc_ions_2000ng_long)

# Combine all data
df_all_ions_long <- bind_rows(df_200ng_clean_long, df_500ng_clean_long, df_1000ng_clean_long, df_2000ng_clean_long)




# Convert your data to data.table
dt_all <- as.data.table(df_all_ions_long)

# Vectorized parsing using data.table
dt_all_parsed <- dt_all[
  , `:=`(
    mass = str_extract(Replicate.Name, "\\d+(?=ng)"),
    IsoWindow = str_extract(Replicate.Name, "\\d(?=mzIso)"),
    replicate = str_extract(Replicate.Name, "\\d+$"),
    instrument = fifelse(grepl("Actis", Replicate.Name), "Prototype", 
                         fifelse(grepl("Astral", Replicate.Name), "Astral", NA_character_)),
    LC.Ion.Count = fifelse(LC.Ion.Count == "#N/A", 
                          NA_real_, 
                          as.numeric(LC.Ion.Count))
  )
][
  , `:=`(
    mass = factor(mass, levels = c("2000", "1000", "500", "200")),
    IsoWindow = fcase(
      IsoWindow == "2", "2 Th with 4 ms IT",
      IsoWindow == "3", "3 Th with 6 ms IT",
      IsoWindow == "4", "4 Th with 8 ms IT",
      default = NA_character_
    )
  )
]



# Apply calibration factors to dt_all_parsed
dt_all_calibrated <- dt_all_parsed[
  , LC.Ion.Count.Calibrated := fcase(
    instrument == "Astral", LC.Ion.Count / 1.53,
    instrument == "Prototype", LC.Ion.Count / 1.31,
    default = NA_real_
  )
]


# Initialize an empty dataframe to store all mode values
all_mode_values <- data.frame()

unique_replicates <- unique(dt_all_parsed$replicate)

# Loop through each replicate and calculate modes using ggplot method
for(rep in unique_replicates) {
  cat("Processing replicate:", rep, "\n")
  
  # Filter for current replicate for Astral
  astral_rep_data <- dt_all_calibrated %>%
    filter(instrument == "Astral", replicate == rep) %>%
    mutate(
      mass = factor(mass, levels = c("200", "500", "1000", "2000"))
    )
  
  # Filter for current replicate for Prototype
  prototype_rep_data <- dt_all_calibrated %>%
    filter(instrument == "Prototype", replicate == rep) %>%
    mutate(
      mass = factor(mass, levels = c("200", "500", "1000", "2000"))
    )
  
  # Create individual plots for this replicate
  p_astral_rep <- ggplot(astral_rep_data, aes(x = LC.Ion.Count.Calibrated, fill = mass)) +
    geom_density(alpha = 0.35) +
    facet_grid(mass ~ IsoWindow) +
    scale_x_log10() +
    theme_bw() +
    labs(title = paste("Astral - Replicate", rep))
  
  p_prototype_rep <- ggplot(prototype_rep_data, aes(x = LC.Ion.Count.Calibrated, fill = mass)) +
    geom_density(alpha = 0.35) +
    facet_grid(mass ~ IsoWindow) +
    scale_x_log10() +
    theme_bw() +
    labs(title = paste("Prototype - Replicate", rep))
  
  # Extract modes using your ggplot method for Astral
  pb_astral_rep <- ggplot_build(p_astral_rep)
  plot_data_astral_rep <- pb_astral_rep$data[[1]]
  panel_layout_astral_rep <- pb_astral_rep$layout$layout %>% select(PANEL, mass, IsoWindow)
  
  plot_data_astral_rep <- left_join(plot_data_astral_rep, panel_layout_astral_rep, by = "PANEL")
  
  astral_modes_rep <- plot_data_astral_rep %>%
    group_by(PANEL, mass, IsoWindow) %>%
    slice_max(y, n = 1, with_ties = FALSE) %>%
    mutate(
      mode_value = 10^x,
      instrument = "Astral",
      replicate = rep
    ) %>%
    select(instrument, mass, IsoWindow, replicate, mode_value)
  
  # Extract modes using your ggplot method for Prototype
  pb_prototype_rep <- ggplot_build(p_prototype_rep)
  plot_data_prototype_rep <- pb_prototype_rep$data[[1]]
  panel_layout_prototype_rep <- pb_prototype_rep$layout$layout %>% select(PANEL, mass, IsoWindow)
  
  plot_data_prototype_rep <- left_join(plot_data_prototype_rep, panel_layout_prototype_rep, by = "PANEL")
  
  prototype_modes_rep <- plot_data_prototype_rep %>%
    group_by(PANEL, mass, IsoWindow) %>%
    slice_max(y, n = 1, with_ties = FALSE) %>%
    mutate(
      mode_value = 10^x,
      instrument = "Prototype",
      replicate = rep
    ) %>%
    select(instrument, mass, IsoWindow, replicate, mode_value)
  
  # Combine with main dataframe
  all_mode_values <- bind_rows(all_mode_values, astral_modes_rep, prototype_modes_rep)
}

# Remove any duplicate entries (just in case)
all_mode_values <- all_mode_values %>%
  distinct(instrument, mass, IsoWindow, replicate, mode_value)

# Let's check the structure of our mode values dataframe
print(head(all_mode_values))
print(paste("Total mode values:", nrow(all_mode_values)))
print(paste("Unique replicates:", length(unique(all_mode_values$replicate))))

# Verify we have the expected number of data points
expected_combinations <- length(unique(all_mode_values$instrument)) * 
  length(unique(all_mode_values$mass)) * 
  length(unique(all_mode_values$IsoWindow)) * 
  length(unique(all_mode_values$replicate))

print(paste("Expected data points:", expected_combinations))
print(paste("Actual data points:", nrow(all_mode_values)))

# Now calculate summary statistics for Figure 5C
summary_modes <- all_mode_values %>%
  group_by(instrument, mass, IsoWindow) %>%
  summarise(
    mean_mode = mean(mode_value, na.rm = TRUE),
    sd_mode = sd(mode_value, na.rm = TRUE),
    n = n(),
    .groups = 'drop'
  )




stat_test_results <- all_mode_values %>%
  group_by(mass, IsoWindow) %>%
  t_test(mode_value ~ instrument, paired = FALSE) %>%
  add_significance("p") %>%
  mutate(p.signif = ifelse(p.signif == "ns", NA, p.signif)) %>%
  add_xy_position(x = "mass", group = "instrument", fun = "max")

# Create Figure 5C with error bars showing variability between replicates
Figure5B = ggplot(summary_modes, aes(x = mass, y = mean_mode, color = instrument, group = instrument)) +
  geom_line(linewidth = 2, alpha = 0.85) +
  geom_point(size = 3, alpha = 0.85) +
  geom_text(
    data = stat_test_results,
    aes(x = x, y = y.position + 0.1, label = p.signif),
    inherit.aes = FALSE,
    size = 5
  )+
  
  
  geom_errorbar(aes(ymin = mean_mode - sd_mode, ymax = mean_mode + sd_mode), width = 0.2) +
  # Add individual replicate points
  
  facet_wrap(~IsoWindow) +
  labs(
    x = "Input HeLa mass (ng)",
    y = "Mean mode LC peak\npeptide ion count (±SD)",
    color = "Instrument") +
  ylim(0, 460) +
  scale_color_manual(values = c( "#7CA0D4","#DE757B")) +
  facet_wrap(~ IsoWindow) +  # Facet by IsoWindow instead of Instrument
  theme_bw() +
  theme(
    text = element_text(size = 16),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
    #legend.title = element_text(size = 14),
    legend.text = element_text(size = 16),
    strip.text = element_text(size = 13),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.title=element_blank(),
    legend.position = "bottom")  


Figure5B


```




## Figure 5C: Percent increase
```{r}

# Calculate percent increase for each condition
percent_increase <- summary_modes %>%
  select(instrument, mass, IsoWindow, mean_mode) %>%
  pivot_wider(names_from = instrument, values_from = mean_mode) %>%
  mutate(
    percent_increase = ((Prototype - Astral) / Astral) * 100,
    fold_increase = Prototype / Astral
  )

# Print the results

# First, calculate percent increase for all conditions
improvement_df <- summary_modes %>%
  select(instrument, mass, IsoWindow, mean_mode) %>%
  pivot_wider(names_from = instrument, values_from = mean_mode) %>%
  mutate(
    pct_increase = ((Prototype - Astral) / Astral) * 100
  )

# Calculate median percent increase across all conditions
median_increase <- round(median(improvement_df$pct_increase), 1)

# Print the median value

# Create the plot with both individual % labels and median annotation
Figure5C = ggplot(improvement_df, aes(x = mass, y = pct_increase, fill = IsoWindow)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.9), alpha = 0.8) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  
  # Fixed: Use consistent dodge width and group by IsoWindow
  geom_text(
  aes(
    label = paste0(round(pct_increase), "%"),  # Rounded to whole number
    y = ifelse(pct_increase > 0, pct_increase + 3, pct_increase - 3),
    group = IsoWindow
  ),
  position = position_dodge(width = 0.9),
  size = 4,
  vjust = ifelse(improvement_df$pct_increase > 0, 0.5, 1),
  angle = 0  # Horizontal text
) +

  scale_fill_manual(values = c("#7CA0D4", "#DE757B", "#8BA56F")) +
  labs(
    x = "Input HeLa mass (ng)",
    y = "% Increase in mode LC peak\nions (Prototype vs Astral)",
    fill = "Isolation Window"
  ) +
  
  annotate(
    "label",
    x = Inf,
    y = Inf,
    label = paste0("Median: ", median_increase, "%"),
    size = 5,
    fontface = "bold",
    hjust = 1.1,
    vjust = 1.5,
    fill = "white",
    alpha = 0.8,
    label.size = NA
  ) +
  
  ylim(0, 60) +
  theme_bw() + 
  theme(
    text = element_text(size = 16),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 15),
    legend.text = element_text(size = 12),
    strip.text = element_text(size = 16),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.title = element_blank(),
    legend.position = "bottom"
  )


Figure5C

```



## Fig5: Reviewer Full plot
```{r, fig.height=12, fig.width=12}



figure5_mode <- (Figure5A / (Figure5B + Figure5C)) + 
  plot_layout(ncol = 1, heights = c(1.4, 0.8))+
  plot_annotation(tag_levels = "A") &
  theme(
    axis.title = element_text(size = 18),
    axis.text  = element_text(size = 16),
    legend.key.size = unit(1.2, "lines"),
    plot.tag = element_text(size = 24, face = "bold")
  )


figure5_mode


ggsave("../figures/Figure_5.pdf", plot = figure5_mode, width = 12, height = 14, dpi = 1000)


```




## Figure S6: Apex total spectrum ions
```{r, fig.width= 12, fig.height=8}


df_apex_ions_200ng = read.csv("../data/hela_isolation_window/apex_spectrum_total_ions/apex_ions_pivot_200ng.csv")
df_apex_ions_500ng = read.csv("../data/hela_isolation_window/apex_spectrum_total_ions/apex_ions_pivot_500ng.csv")
df_apex_ions_1000ng = read.csv("../data/hela_isolation_window/apex_spectrum_total_ions/apex_ions_pivot_1000ng.csv")
df_apex_ions_2000ng = read.csv("../data/hela_isolation_window/apex_spectrum_total_ions/apex_ions_pivot_2000ng.csv")


df_apex_ions_200ng_cleaned = clean_df_columns_fn(df_apex_ions_200ng)
df_apex_ions_500ng_cleaned = clean_df_columns_fn(df_apex_ions_500ng)
df_apex_ions_1000ng_cleaned = clean_df_columns_fn(df_apex_ions_1000ng)
df_apex_ions_2000ng_cleaned = clean_df_columns_fn(df_apex_ions_2000ng)


df_apex_ions_200ng_format = split_columns_to_lc_ion_dfs(df_apex_ions_200ng_cleaned)
df_apex_ions_500ng_format = split_columns_to_lc_ion_dfs(df_apex_ions_500ng_cleaned)
df_apex_ions_1000ng_format = split_columns_to_lc_ion_dfs(df_apex_ions_1000ng_cleaned)
df_apex_ions_2000ng_format = split_columns_to_lc_ion_dfs(df_apex_ions_2000ng_cleaned)


df_apex_ions_combined = bind_rows(df_apex_ions_200ng_format,
                                df_apex_ions_500ng_format,
                                df_apex_ions_1000ng_format,
                                df_apex_ions_2000ng_format)


df_apex_ions_combined1 = df_apex_ions_combined


df_apex_ions_combined1 <- df_apex_ions_combined1 %>%
  mutate(IsoWindow = recode(IsoWindow,
    "2mz" = "2 Th with 4 ms IT",
    "3mz" = "3 Th with 6 ms IT",
    "4mz" = "4 Th with 8 ms IT"
  ))



df_apex_ions_combined1$instrument <- ifelse(grepl("Astral", df_apex_ions_combined$instrument, ignore.case = TRUE), "Astral",
                     ifelse(grepl("Actis", df_apex_ions_combined$instrument, ignore.case = TRUE), "Prototype",NA))

df_apex_ions_combined1$instrument <- factor(df_lc_ions_combined1$instrument, levels = c("Astral","Prototype"))
df_apex_ions_combined1$mass <- factor(df_apex_ions_combined1$mass, levels = c("2000", "1000", "500", "200"))


df_apex_ions_combined1$Mean_corrected <- round(ifelse(
  df_apex_ions_combined1$instrument == "Prototype",
  df_apex_ions_combined1$Mean / 1.31,
  ifelse(
    df_apex_ions_combined1$instrument == "Astral",
    df_apex_ions_combined1$Mean / 1.53,
    df_apex_ions_combined1$Mean 
  )
))




figure6_supp_apex = ggplot(df_apex_ions_combined1, aes(x = factor(mass), y = Mean_corrected, fill = instrument)) +
  #coord_cartesian(ylim = c(0, 50)) +
  geom_hline(yintercept = 20000 / 1.31, linetype = "dashed", color = "#D6604D", alpha = 0.75, linewidth = 1) +
  geom_hline(yintercept = 20000 / 1.53, linetype = "dashed", color = "#4393C3", alpha = 0.75, linewidth = 1) +
  geom_split_violin(alpha = 0.7, trim = TRUE, draw_quantiles = 0.5) +

  scale_y_log10(
    breaks = 10^(2:5),  # only 10^2, 10^3, 10^4, 10^5

    #breaks = trans_breaks("log10", function(x) 10^x),
    labels = trans_format("log10", math_format(10^.x))
  ) +
  coord_cartesian(ylim = c(10^2, 10^5)) + 

  facet_wrap(~ IsoWindow, ncol = 3) +
  theme_bw() +
  labs(x = "Input HeLa mass (ng)", y = "Apex total spectrum ion count", title = " ") +
  scale_fill_manual(values = c("Astral" = "#4393C3", "Prototype" = "#D6604D")) + 
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    panel.grid.major = element_line(linetype = "solid", color = "gray80"),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5),
    axis.title = element_text(size = 22),
    axis.text = element_text(size = 20),
      strip.text = element_text(size = 20),  
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.text = element_text(size = 18),      # <-- Increase text size
    #legend.title = element_text(size = 16),     # <-- (optional) title size
    legend.key.size = unit(1.2, "lines"),
  ) +
  theme(plot.title = element_text(size = 22, hjust = 0))


figure6_supp_apex

ggsave("../figures/Figure_S6_supp_apex.pdf", plot = figure6_supp_apex, width = 12, height = 8, dpi = 700)



```





## Figure S7: Full distr Log2 Ratio LC IONS
```{r, fig.width=12, fig.height=14}



df_normalized <- df_lc_ions_combined1 %>%
  mutate(NormalizedMean = case_when(
    instrument == "Astral" ~ round(Mean / 1.53),
    instrument == "Actis" ~ round(Mean / 1.31),
    TRUE ~ NA_real_
  ))


df_wide <- df_normalized %>%
  pivot_wider(
    id_cols = c(Protein, Peptide, Precursor, mass, IsoWindow),
    names_from = instrument,
    values_from = c(Mean)
  )

df_ratios <- df_wide %>%
  mutate(
    Mean_ratio = Prototype / Astral,
    log2MeanRatio = log2(Mean_ratio)
  )




#df_ratios$mass <- paste0(as.character(df_ratios$mass), "ng")
df_ratios$mass <- factor(df_ratios$mass, levels = c("2000ng", "1000ng", "500ng", "200ng", "50ng"))

summary_ions <- df_ratios %>%
  group_by(mass, IsoWindow) %>%
  summarise(
    median_log2 = median(log2MeanRatio, na.rm = TRUE),
    median_ions = median(Prototype, na.rm = TRUE),
    #median_ion_diff = median(ion_diff, na.rm = TRUE)
  )


# Calculate medians with color labels
medians_lc_ions_df <- df_ratios %>%
  group_by(mass, IsoWindow) %>%
  summarize(median_log2 = median(log2MeanRatio, na.rm = TRUE)) %>%
  mutate(median_value_corr =2^ median_log2) %>%
  mutate(
    color = ifelse(median_value_corr > 1, "red", "blue"),
    label = sprintf("Median: %.2f", median_value_corr)
  )


my_13_colors <- c(
  "#ffffff",  # white (low density)
  "#577590",  # cBlue
  "#4d908e",  # cGreen3
  "#43aa8b",  # cGreen2
  "#90be6d",  # cGreen1
  "#f9c74f",  # cYellow
  "#f8961e",  # cOrange2
  "#f3722c",  # cOrange1
  "#f94144",  # cRed
  "#b62e2e",  # deep red
  "#800000"   # darkest red (highest density)
)



# Plot just 500ng
figureS7_supp_full_dist = ggplot(df_ratios, aes(x = Prototype, y = log2MeanRatio)) +
  geom_density_2d_filled(contour_var = "density", bins = 11) +

  # Reference line at log2(1)
  geom_hline(
    yintercept = 0,
    linetype = "solid",
    color = "black",
    linewidth = 0.6,
    alpha = 0.8
  ) +

  # Median lines, colored
  geom_hline(
    data = medians_lc_ions_df,
    aes(yintercept = median_log2, color = color),
    linetype = "dashed",
    linewidth = 1.2,
    show.legend = FALSE
  ) +

  # Median labels
  geom_text(
    data = summary_ions, #medians_lc_ions_df
    aes(
      x = Inf,
      y = Inf,
      label = sprintf("Median ions = %.2f", median_log2)
    ),
    hjust = 1.1,
    vjust = 1.4,
    size = 6,
    color = "black",
    inherit.aes = FALSE
  ) +

  facet_grid(mass ~ IsoWindow) +
  scale_x_log10(  limits = c(10^0.5, NA),  # start at ~3.16

    breaks = trans_breaks("log10", function(x) 10^x),
    labels = trans_format("log10", math_format(10^.x)),
    expand = expansion(mult = 0)
  ) +
  coord_cartesian(ylim = c(-1, 1.22)) +
  scale_y_continuous(breaks = seq(-1, 1.22, by = 0.5)) +

  scale_fill_manual(values = my_13_colors, name = "Point density")+
  scale_color_manual(values = c("blue" = "#4393C3", "red" = "#D6604D"),   guide = "none") +

  labs(
    x = "Prototype LC peak ions",
    y = "Log2(Prototype / Astral LC peak ions)"
  ) +

  theme_bw() +
  theme(
    legend.position = "bottom",
    legend.title = element_text(size = 14),
    axis.title = element_text(size = 20),
    axis.text = element_text(size = 20),
      strip.text = element_text(size = 20),  
    axis.text.x = element_text(hjust = 1),
    legend.text = element_text(size = 14),      # <-- Increase text size
    axis.ticks.x = element_line(size = 0.5),
    axis.ticks.length = unit(0.25, "cm"),
    #legend.title = element_text(size = 16),     # <-- (optional) title size
    legend.key.size = unit(1.2, "lines"),

    #panel.spacing = unit(2, "lines")  # increase or decrease spacing

  ) + theme(plot.title = element_text(size = 22, hjust = 0)) + annotation_logticks(sides = "b")
 

figureS7_supp_full_dist


ggsave("../figures/Figure_S7.pdf", plot = figureS7_supp_full_dist, width = 12, height = 14, dpi = 700)


```


